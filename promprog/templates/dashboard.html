{% extends "base.html" %}
{% block title %}
{% if rights == 2 %}–†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ –ø–æ–≤–∞—Ä–∞{% elif rights == 3 %}–ö–∞–±–∏–Ω–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞{% else %}–ú–µ–Ω—é —Å—Ç–æ–ª–æ–≤–æ–π{% endif %}
{% endblock %}

{% block content %}
<div class="container pb-5">

    <!-- 1. –ó–ê–ì–û–õ–û–í–û–ö –°–¢–†–ê–ù–ò–¶–´ -->
    <div class="d-flex flex-wrap justify-content-between align-items-end mb-5 gap-3">
        <div>
            <h1 class="fw-bold mb-1">
                {% if rights == 0 %}–ú–µ–Ω—é —Å—Ç–æ–ª–æ–≤–æ–π üç¥{% endif %}
                {% if rights == 1 and first_name != "" %}–ü—Ä–∏–≤–µ—Ç, {{ first_name }}! üëã{% endif %}
                {% if rights == 1 and first_name == "" %}–ü—Ä–∏–≤–µ—Ç! üëã{% endif %}
                {% if rights == 2 %}–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—É—Ö–Ω–µ–π üë®‚Äçüç≥{% endif %}
                {% if rights == 3 %}–ö–∞–±–∏–Ω–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ üëî{% endif %}
            </h1>
            <p class="text-secondary mb-0">
                {% if rights == 0 %}–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑.{% endif %}
                {% if rights == 1 %}
                <span class="d-inline-flex align-items-center gap-2 flex-wrap">
                    <!-- –ü–ò–õ–Æ–õ–Ø –° –ë–ê–õ–ê–ù–°–û–ú -->
                    <span class="badge rounded-pill bg-light border text-dark px-3 py-2 shadow-sm"
                        style="font-weight: 600;">
                        <i class="bi bi-cash-coin text-success me-1"></i>
                        –ë–∞–ª–∞–Ω—Å:
                        <span class="text-success fw-bold">{{ money }} ‚ÇΩ</span>
                    </span>

                    <!-- –ö–ù–û–ü–ö–ê –¢–û–ì–û –ñ–ï –†–ê–ó–ú–ï–†–ê -->
                    <a href="{{ url_for('payment') }}"
                        class="btn btn-primary-custom btn-pill shadow-sm btn-sm px-3 py-2">
                        <i class="bi bi-wallet2 me-1"></i>–ü–æ–ø–æ–ª–Ω–∏—Ç—å
                    </a>
                </span>
                {% endif %}

                {% if rights == 1 %}{% if abonement != "null" %}<br><br>–ê–∫—Ç–∏–≤–µ–Ω –∞–±–æ–Ω–µ–º–µ–Ω—Ç: <span
                    class="fw-bold text-success">{{abonement}}</span>{% endif %}{% endif %}
                {% if rights == 2 %}–£—á–µ—Ç –≤—ã–¥–∞—á–∏ –±–ª—é–¥, –∫–æ–Ω—Ç—Ä–æ–ª—å —Å–∫–ª–∞–¥–∞ –∏ –∑–∞–∫—É–ø–∫–∏.{% endif %}
                {% if rights == 3 %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–æ–∫ –∏ –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å.{% endif %}
            </p>
        </div>

        <!-- –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô -->
        {% if rights == 0 %}
        <div class="d-flex gap-2">
            <a href="{{ url_for('login') }}" class="btn btn-primary-custom btn-pill shadow-sm">
                –í–æ–π—Ç–∏ –¥–ª—è –∑–∞–∫–∞–∑–∞
            </a>
        </div>
        {% endif %}
    </div>

    <!-- ============================================== -->
    <!-- 2. –†–û–õ–¨: –£–ß–ï–ù–ò–ö (1) –ò –ì–û–°–¢–¨ (0) - –ú–ï–ù–Æ     -->
    <!-- ============================================== -->
    {% if rights == 1 or rights == 0 %}

    {% if rights == 1 %}
    <!-- –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –û –ì–û–¢–û–í–û–ú –ó–ê–ö–ê–ó–ï -->
    {% set active_order = {'items': ['–ë–æ—Ä—â', '–ö–æ—Ç–ª–µ—Ç–∞ —Å –ø—é—Ä–µ', '–ö–æ–º–ø–æ—Ç'], 'time': '12:30'} %}
    {% if takequeries|length > 0 %}
    {% for query in takequeries %}
    <div class="alert alert-success border border-success bg-light border-2 border-opacity-25 rounded-3 p-3 mb-4 shadow-sm"
        role="alert">
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-3">
                <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center"
                    style="width: 40px; height: 40px;">
                    <i class="bi bi-bell-fill"></i>
                </div>
                <div>
                    <h6 class="fw-bold mb-0">–í–∞—à –∑–∞–∫–∞–∑ –≥–æ—Ç–æ–≤!</h6>
                    <p class="text-muted small mb-0">–ó–∞–±–µ—Ä–∏—Ç–µ –µ–≥–æ –≤ —Å—Ç–æ–ª–æ–≤–æ–π</p>
                </div>
            </div>
        </div>
        <div class="mt-3 pt-3 border-top">
            <p class="small text-muted mb-2">–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:</p>
            <div class="d-flex flex-wrap gap-1">
                {% for product in query['products'] %}
                <span class="badge bg-light border text-dark small ">{{ product }}</span>
                {% endfor %}
            </div>
            <form id="takeform{{query['id']}}" method="post" action="/got_food/{{query['id']}}">
                <div class="mt-2">
                    <input hidden type="text" value="{{query['id']}}">
                    <button type="submit" class="btn btn-sm btn-success btn-pill">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ</button>
                </div>
            </form>
        </div>
    </div>
    {% endfor %}
    {% endif %}
    {% endif %}

    <div class="row g-4">
        <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê -->
        <div class="col-lg-3">
            <div class="sticky-top" style="top: 20px;">

                <!-- –û–ë–™–ï–î–ò–ù–ï–ù–ù–´–ô –ë–õ–û–ö: –§–ò–õ–¨–¢–†–´ + –ö–û–†–ó–ò–ù–ê -->
                <div class="card border-0 shadow-sm mb-4">

                    <!-- 2.1 –§–ò–õ–¨–¢–†–´ -->
                    <div class="p-3 border-bottom">
                        <div class="mb-4">
                            <span class="filter-group-title">–ö–ê–¢–ï–ì–û–†–ò–ò</span>
                            <div class="d-flex flex-column gap-2">
                                <div class="form-check"><input class="form-check-input filter-checkbox" type="checkbox"
                                        value="–ü–µ—Ä–≤–æ–µ" checked id="c1"><label class="form-check-label cursor-pointer"
                                        for="c1">–ü–µ—Ä–≤–æ–µ</label></div>
                                <div class="form-check"><input class="form-check-input filter-checkbox" type="checkbox"
                                        value="–í—Ç–æ—Ä–æ–µ" checked id="c2"><label class="form-check-label cursor-pointer"
                                        for="c2">–í—Ç–æ—Ä–æ–µ</label></div>
                                <div class="form-check"><input class="form-check-input filter-checkbox" type="checkbox"
                                        value="–ù–∞–ø–∏—Ç–∫–∏" checked id="c3"><label class="form-check-label cursor-pointer"
                                        for="c3">–ù–∞–ø–∏—Ç–∫–∏</label></div>
                                <div class="form-check"><input class="form-check-input filter-checkbox" type="checkbox"
                                        value="–°–∞–ª–∞—Ç—ã" checked id="c4"><label class="form-check-label cursor-pointer"
                                        for="c4">–°–∞–ª–∞—Ç—ã</label></div>
                                <div class="form-check"><input class="form-check-input filter-checkbox" type="checkbox"
                                        value="–§—Ä—É–∫—Ç—ã" checked id="c5"><label class="form-check-label cursor-pointer"
                                        for="c5">–§—Ä—É–∫—Ç—ã</label></div>
                                <div class="form-check"><input class="form-check-input filter-checkbox" type="checkbox"
                                        value="–í—ã–ø–µ—á–∫–∞" checked id="c6"><label class="form-check-label cursor-pointer"
                                        for="c6">–í—ã–ø–µ—á–∫–∞</label></div>
                            </div>
                        </div>

                        {% if rights == 1 %}
                        <div class="mb-4">
                            <span class="filter-group-title">–ó–î–û–†–û–í–¨–ï</span>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="allergyFilter" {% if allergies
                                    %}checked{% endif %}>
                                <label class="form-check-label fw-bold" for="allergyFilter">–°–∫—Ä—ã—Ç—å –∞–ª–ª–µ—Ä–≥–µ–Ω—ã</label>
                            </div>
                        </div>

                        <div class="p-3 bg-light rounded-3 border">
                            <small class="fw-bold text-muted">–í–∞—à–∏ –∞–ª–ª–µ—Ä–≥–µ–Ω—ã:</small>
                            <div class="d-flex gap-1 flex-wrap mt-2">
                                {% if allergies %}{% for alg in allergies %}<span
                                    class="badge bg-danger bg-opacity-10 text-danger border border-danger">{{ alg
                                    }}</span>{% endfor %}{% else %}<span class="text-muted small">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>{%
                                endif
                                %}
                            </div>
                            <a href="{{ url_for('profile') }}"
                                class="d-block small text-primary text-decoration-none mt-2">–ò–∑–º–µ–Ω–∏—Ç—å –≤ –ø—Ä–æ—Ñ–∏–ª–µ</a>
                        </div>
                        {% endif %}
                    </div>

                    <!-- 2.2 –ö–û–†–ó–ò–ù–ê (–í–ê–® –ó–ê–ö–ê–ó) -->
                    {% if rights == 1 %}
                    <div class="p-3">
                        <div class="d-flex align-items-center gap-2 mb-3 border-bottom pb-2">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center"
                                style="width: 32px; height: 32px;"><i class="bi bi-basket2"></i></div>
                            <h5 class="fw-bold mb-0">–í–∞—à –∑–∞–∫–∞–∑</h5>
                        </div>

                        {% if cart_items %}
                        <div class="d-flex flex-column gap-2 mb-3" style="max-height: 200px; overflow-y: auto;">
                            <!-- –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–ª–æ–Ω–æ–∫ -->
                            <div
                                class="d-flex justify-content-between align-items-center small text-muted border-bottom pb-1">
                                <span class="flex-grow-1">–¢–æ–≤–∞—Ä</span>
                                <span class="text-end" style="min-width: 100px;">–ö–æ–ª-–≤–æ –∏ —Ü–µ–Ω–∞</span>
                            </div>

                            {% for item in cart_items %}
                            {% if item[1] == 1 %}
                            <div class="d-flex justify-content-between align-items-center small">
                                <span class="flex-grow-1">{{ item[0].name }}</span>
                                <div class="d-flex align-items-center justify-content-end"
                                    style="min-width: 100px; gap: 8px;">
                                    <span>{{ item[1] }}</span>
                                    <span class="fw-bold">√ó</span>
                                    <span>{{ item[0].price }} ‚ÇΩ</span>
                                </div>
                            </div>
                            {% else %}
                            <div class="d-flex justify-content-between align-items-center small" style="color: red;">
                                <span class="flex-grow-1" style="color: blue;">{{ item[0].name }}</span>
                                <div class="d-flex align-items-center justify-content-end"
                                    style="min-width: 100px; gap: 8px; color: blue;">
                                    <span>{{ item[1] }}</span>
                                    <span class="fw-bold">√ó</span>
                                    <span>{{ item[0].price }} ‚ÇΩ</span>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>

                        <div class="d-flex justify-content-between align-items-center border-top pt-2 mb-3">
                            <span class="text-muted">–ò—Ç–æ–≥–æ:</span>
                            <span class="fw-bold fs-5 text-primary">{{ cart_total }} ‚ÇΩ</span>
                        </div>
                        <div class="d-grid gap-2">
                            <form action="{{ url_for('pay') }}" method="post">
                                <input required type="date" id="datepicker" name="date" class="form-control rounded-3"
                                    style="margin-left: auto; margin-right: auto; margin-bottom: 10px;"
                                    value="{{ now_date }}"></input>
                                <button type="submit" class="btn btn-success btn-sm rounded-pill"
                                    style="width: 100%;">–û–ø–ª–∞—Ç–∏—Ç—å</button>
                            </form>
                            <a href="{{ url_for('clear_cart') }}"
                                class="btn btn-light border btn-sm rounded-pill text-danger">–û—á–∏—Å—Ç–∏—Ç—å</a>
                        </div>
                        {% else %}
                        <div class="text-center py-3 text-muted small">
                            –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.<br>–î–æ–±–∞–≤—å—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –≤–∫—É—Å–Ω–æ–µ!
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                <!-- –ö–û–ù–ï–¶ –û–ë–™–ï–î–ò–ù–ï–ù–ù–û–ì–û –ë–õ–û–ö–ê -->

            </div>
        </div>

        <!-- –°–ï–¢–ö–ê –¢–û–í–ê–†–û–í (–°–ü–†–ê–í–ê) -->
        <div class="col-lg-9">
            <div class="row g-4" id="productsGrid">
                {% if tovarlist %}

                {% for id, item in tovarlist.items() %}

                {% set ns = namespace(is_dangerous=false, danger_reason="") %}
                {% if allergies and item.allergens %}
                {% for prod_allergen in item.allergens %}
                {% if prod_allergen in allergies %}
                {% set ns.is_dangerous = true %}
                {% set ns.danger_reason = prod_allergen %}
                {% endif %}
                {% endfor %}
                {% endif %}

                <div class="col-md-4 col-sm-6 product-item" data-category="{{ item.category }}"
                    data-allergen="{{ 'true' if ns.is_dangerous else 'false' }}">

                    <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä -->
                    <div
                        class="product-card h-100 d-flex flex-column position-relative bg-white rounded-4 border overflow-hidden">

                        {% if ns.is_dangerous %}
                        <div class="position-absolute top-0 start-0 w-100 h-100 bg-white bg-opacity-75 d-flex align-items-center justify-content-center danger-overlay"
                            style="z-index: 10; display: none;">
                            <span class="badge bg-danger fs-6 shadow"><i
                                    class="bi bi-exclamation-triangle-fill me-1"></i> –°–æ–¥–µ—Ä–∂–∏—Ç: {{ ns.danger_reason
                                }}</span>
                        </div>
                        {% endif %}

                        <a href="{{ url_for('product_detail', id=id) }}" class="text-decoration-none text-dark">
                            <div class="product-img-wrapper d-flex align-items-center justify-content-center bg-light"
                                style="height: 180px;">
                                {% if item.badge %}
                                <span
                                    class="product-badge text-white position-absolute top-0 start-0 m-3 px-2 py-1 rounded-pill small"
                                    style="background-color: {{ item.color }};">{{ item.badge }}</span>
                                {% endif %}
                                <image src="{{ url_for('static', filename='images/tovars/' + id|string + '.png') }}"
                                    style="width: 120px;"></image>
                            </div>
                        </a>

                        <div class="p-3 d-flex flex-column flex-grow-1">
                            <div class="text-muted small mb-1">{{ item.category }}</div>
                            <h6 class="fw-bold mb-2 text-truncate">{{ item.name }}</h6>

                            {% if item.allergens %}
                            <div class="mb-2">
                                {% for alg in item.allergens %}
                                {% if alg in allergies %}
                                <span class="badge bg-danger bg-opacity-10 text-danger border border-danger"
                                    style="font-size: 0.65rem;">{{ alg }}</span>
                                {% else %}
                                <span class="badge bg-light text-secondary border" style="font-size: 0.65rem;">{{ alg
                                    }}</span>
                                {% endif %}
                                {% endfor %}
                            </div>
                            {% endif %}

                            <div class="mt-auto d-flex justify-content-between align-items-center pt-2">
                                <span class="fw-bold text-primary fs-5">{{ item.price }} ‚ÇΩ</span>

                                <!-- –ö–ù–û–ü–ö–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø –í –ö–û–†–ó–ò–ù–£ -->
                                {% if rights == 1 %}
                                <div style="display: flex; align-items: center;">
                                    {% for j in cart_items %}
                                    {% if j[0]['name'] == item['name'] %}
                                    <a href="{{ url_for('remove_from_cart', id=id) }}"
                                        class="btn btn-sm btn-light border rounded-circle shadow-sm hover-primary d-flex align-items-center justify-content-center"
                                        style="width: 32px; height: 32px; display: inline-block;">
                                        -
                                    </a>
                                    <span style="margin: 0 8px;">{{j[1]}}</span>
                                    {% endif %}
                                    {% endfor %}
                                    <a href="{{ url_for('add_to_cart', id=id) }}"
                                        class="btn btn-sm btn-light border rounded-circle shadow-sm hover-primary d-flex align-items-center justify-content-center"
                                        style="width: 32px; height: 32px; display: inline-block;">
                                        <i class="bi bi-plus-lg"></i>
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="col-12 text-center py-5">
                    <h4 class="text-muted">–ú–µ–Ω—é –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–ª–∏ –ø—É—Å—Ç–æ...</h4>
                </div>
                {% endif %}
            </div>

            <div id="noResults" class="text-center py-5 d-none">
                <i class="bi bi-search fs-1 text-muted opacity-25"></i>
                <p class="text-muted mt-3">–ù–µ—Ç –±–ª—é–¥, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–∞–º.</p>
            </div>
        </div>
    </div>
    {% endif %}


    <!-- ============================================== -->
    <!-- 3. –†–û–õ–¨ 2: –ü–û–í–ê–† / –°–û–¢–†–£–î–ù–ò–ö                   -->
    <!-- ============================================== -->
    {% if rights == 2 %}

    <!-- KPI –ö–ê–†–¢–û–ß–ö–ò -->
    <div class="row g-4 mb-4">
        <div class="col-md-12">
            <div class="card border-0 shadow-sm p-3 h-100">
                <div class="d-flex align-items-center gap-3">
                    <div class="bg-warning bg-opacity-10 text-warning p-3 rounded-3"><i class="bi bi-clock-history"></i>
                    </div>
                    <div>
                        <h3 class="fw-bold mb-0">{{querylist|length}}</h3>
                        <small class="text-muted">–û–∂–∏–¥–∞—é—Ç –≤—ã–¥–∞—á–∏</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –¢–ê–ë–´ –ü–û–í–ê–†–ê -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-bottom pt-3 px-4">
            <ul class="nav nav-tabs card-header-tabs" id="cookTabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link text-secondary" data-bs-toggle="tab" data-bs-target="#orders">
                        <i class="bi bi-list-check me-2"></i>–í—ã–¥–∞—á–∞ –±–ª—é–¥
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link text-secondary" data-bs-toggle="tab" data-bs-target="#inventory">
                        <i class="bi bi-box-seam me-2"></i>–°–∫–ª–∞–¥ –∏ –û—Å—Ç–∞—Ç–∫–∏
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link text-secondary" data-bs-toggle="tab" data-bs-target="#requests">
                        <i class="bi bi-cart-plus me-2"></i>–ó–∞—è–≤–∫–∞ –Ω–∞ –∑–∞–∫—É–ø–∫—É
                    </button>
                </li>
            </ul>
        </div>

        <div class="card-body p-4">
            <div class="tab-content">

                <!-- 3.0 –°–¢–†–ê–ù–ò–¶–ê "–ü–†–ò–°–£–¢–ü–ò–ú" -->
                <div class="tab-pane fade" id="begin">
                    <h1 style="margin-left: auto; margin-right: auto; margin-left: auto; margin-right: auto;">–î–∞–≤–∞–π—Ç–µ
                        –ø—Ä–∏—Å—Ç—É–ø–∏–º</h1>
                </div>

                <!-- 3.1 –í–´–î–ê–ß–ê -->
                <div class="tab-pane fade" id="orders">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold mb-0">–¢–µ–∫—É—â–∞—è –æ—á–µ—Ä–µ–¥—å</h5>
                    </div>
                    <div class="table-modern-container">
                        <table class="table-modern">
                            <thead>
                                <tr>
                                    <th class="ps-4">–£—á–µ–Ω–∏–∫</th>
                                    <th>–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞</th>
                                    <th>–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏</th>
                                    <th>–í—Ä–µ–º—è</th>
                                    <th class="text-end pe-4">–î–µ–π—Å—Ç–≤–∏–µ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for query in querylist %}
                                <tr id="order-{{query.id}}">
                                    <td class="ps-4 fw-bold">{{query['name']}}</td>
                                    <td>
                                        {% for item in range(0, query['products']|length) %}
                                        {% if item != query['products']|length - 1 %}
                                        {{query['products'][item] + ','}}
                                        {% else %}
                                        {{query['products'][item]}}
                                        {% endif %}
                                        {% endfor %}
                                    </td>
                                    <td class="text-muted small">{{query['date']}}</td>
                                    <td class="text-muted small">{{query['time']}}</td>
                                    <form id="give{{query['id']}}" action="/send_food/{{query['id']}}" method="get">
                                        <td class="text-end pe-4">
                                            <button class="btn btn-sm btn-primary-custom btn-pill px-3">–í—ã–¥–∞—Ç—å</button>
                                        </td>
                                    </form>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 3.2 –°–ö–õ–ê–î -->
                <div class="tab-pane fade" id="inventory">
                    <div class="row g-4">
                        {% for product in productlist %}
                        <div class="col-md-6">
                            <div class="border rounded-3 p-3 position-relative">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="fw-bold">{{productlist[product]['name']}}
                                        {{productlist[product]['suffix']}}</span>
                                    <!-- –ö–Ω–æ–ø–∫–∞ –ò–∑–º–µ–Ω–∏—Ç—å -->
                                    <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal"
                                        data-bs-target="#editModal" data-product-name="{{productlist[product]['name']}}"
                                        data-current-count="{{productlist[product]['cnt']}}"
                                        data-max-count="{{productlist[product]['max']}}"
                                        data-suffix="{{productlist[product]['suffix']}}">
                                        –ò–∑–º–µ–Ω–∏—Ç—å
                                    </button>
                                </div>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-success"
                                        style="width: {{100.0 * (((productlist[product]['cnt'])|float) / ((productlist[product]['max'])|float))}}%">
                                    </div>
                                </div>
                                <small class="text-muted">–û—Å—Ç–∞—Ç–æ–∫: {{productlist[product]['cnt']}} –∏–∑
                                    {{productlist[product]['max']}} {{productlist[product]['suffix']}}</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- 3.3 –ó–ê–Ø–í–ö–ò -->
                <div class="tab-pane fade" id="requests">
                    <div class="row">
                        <div class="col-lg-5 mb-4 mb-lg-0">
                            <div class="bg-light p-4 rounded-4">
                                <h5 class="fw-bold mb-3">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</h5>
                                <form id="purchaseForm" action="{{ url_for('buy_to_admin') }}" method="post">
                                    <div class="mb-3">
                                        <label class="form-label small fw-bold text-muted">–ü—Ä–æ–¥—É–∫—Ç</label>
                                        <select class="form-select rounded-3" id="prod" name="prod" required>
                                            {% for product in productlist %}
                                            <option value="{{product}}">{{productlist[product]['name']}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label small fw-bold text-muted">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–∫–≥/–ª/—à—Ç)</label>
                                        <input type="number" class="form-control rounded-3" id="prodAmount"
                                            name="volume" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 50" required max="1000000" min="1">
                                    </div>
                                    <button type="submit" class="btn btn-primary-custom btn-pill w-100">–û—Ç–ø—Ä–∞–≤–∏—Ç—å
                                        –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É</button>
                                </form>
                            </div>
                        </div>

                        <div class="col-lg-7">
                            <h5 class="fw-bold mb-3">–ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫</h5>
                            <div class="list-group list-group-flush" id="requestsList">
                                {% for i in range(toadmin|length - 1, [-1, toadmin|length - 7]|max, -1) %}
                                <div
                                    class="list-group-item px-0 border-bottom d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="fw-bold mb-0">{{ toadmin[i]["prod"] }} ({{ toadmin[i]["volume"] }})
                                        </h6><small class="text-muted">{{ toadmin[i]["when"] }}
                                        </small>
                                    </div>
                                    {% if toadmin[i]['status'] == 0 %}
                                    <span class="badge bg-secondary bg-opacity-10 text-secondary">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</span>
                                    {% elif toadmin[i]['status'] == 1 %}
                                    <span class="badge bg-success bg-opacity-10 text-success">–û–¥–æ–±—Ä–µ–Ω–æ</span>
                                    {% elif toadmin[i]['status'] == -1 %}
                                    <span class="badge bg-danger bg-opacity-10 text-danger">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</span>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    {% endif %}


    <!-- ============================================== -->
    <!-- 4. –†–û–õ–¨ 3: –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†                   -->
    <!-- ============================================== -->
    {% if rights == 3 %}

    <!-- ============================================== -->
    <!-- 4. –†–û–õ–¨ 3: –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†                   -->
    <!-- ============================================== -->
    {% if rights == 3 %}

    <!-- –¢–ê–ë–´ –ê–î–ú–ò–ù–ê -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-bottom pt-3 px-4">
            <ul class="nav nav-tabs card-header-tabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link text-secondary" data-bs-toggle="tab" data-bs-target="#stats">
                        <i class="bi bi-bar-chart-fill me-2"></i>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link text-secondary" data-bs-toggle="tab" data-bs-target="#admin-requests">
                        <i class="bi bi-inbox-fill me-2"></i>–ó–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–∫—É–ø–∫—É
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link text-secondary" data-bs-toggle="tab" data-bs-target="#balance-requests">
                        <i class="bi bi-cash-stack me-2"></i>–ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link text-secondary" data-bs-toggle="tab" data-bs-target="#reports">
                        <i class="bi bi-file-earmark-text-fill me-2"></i>–û—Ç—á–µ—Ç—ã
                    </button>
                </li>
            </ul>
        </div>

        <div class="card-body p-4">
            <div class="tab-content">

                <!-- 4.0 –°–¢–†–ê–ù–ò–¶–ê "–ü–†–ò–°–£–¢–ü–ò–ú" -->
                <div class="tab-pane fade" id="begin">
                    <h1 style="margin-left: auto; margin-right: auto; margin-left: auto; margin-right: auto;">–î–∞–≤–∞–π—Ç–µ
                        –ø—Ä–∏—Å—Ç—É–ø–∏–º</h1>
                </div>

                <!-- 4.1 –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
                <div class="tab-pane fade" id="stats">
                    <!-- KPI Cards -->
                    <div class="row g-4 mb-4">
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm p-4 bg-light">
                                <h6 class="text-muted text-uppercase small fw-bold">–í—ã—Ä—É—á–∫–∞ –∑–∞ –¥–µ–Ω—å</h6>
                                <h2 class="fw-bold text-primary mb-0">{{admin_money}} ‚ÇΩ</h2>
                                <small class="text-muted"><br></small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm p-4 bg-light">
                                <h6 class="text-muted text-uppercase small fw-bold">–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</h6>
                                <h2 class="fw-bold text-dark mb-0">85%</h2>
                                <small class="text-muted">640 –∏–∑ 750 —É—á–µ–Ω–∏–∫–æ–≤</small>
                            </div>
                        </div>
                    </div>

                    <!-- –ì—Ä–∞—Ñ–∏–∫ -->
                    <div class="card border-0 shadow-sm p-4">
                        <h5 class="fw-bold mb-4">–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ (–Ω–µ–¥–µ–ª—è)</h5>
                        <div style="height: 300px;">
                            <canvas id="attendanceChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 4.2 –°–û–ì–õ–ê–°–û–í–ê–ù–ò–ï –ó–ê–ö–£–ü–û–ö -->
                <div class="tab-pane fade" id="admin-requests">
                    <h5 class="fw-bold mb-3">–ó–∞—è–≤–∫–∏ –æ—Ç –∫—É—Ö–Ω–∏</h5>
                    <div class="table-modern-container">
                        <table class="table-modern">
                            <thead>
                                <tr>
                                    <th class="ps-4">–ü—Ä–æ–¥—É–∫—Ç</th>
                                    <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                    <th>–ü–æ–≤–∞—Ä</th>
                                    <th>–î–∞—Ç–∞</th>
                                    <th class="text-end pe-4">–†–µ—à–µ–Ω–∏–µ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in toadmin %}
                                {% if item['status'] == 0 %}
                                <tr id="req-{{item['id']}}">
                                    <form id="req-form-{{item['id']}}" action="{{ url_for('set_admin_query') }}"
                                        method="post">
                                        <input value="{{item['id']}}" type="text" name="id" id="id{{item['id']}}"
                                            hidden>
                                        <td class="ps-4 fw-bold">{{item['prod']}}</td>
                                        <td>{{item['volume']}}</td>
                                        <td>{{item['person']}}</td>
                                        <td class="text-muted small">{{item['when']}}</td>
                                        <td class="text-end pe-4">
                                            <button name="result" value=1 type="submit"
                                                class="btn btn-sm btn-success rounded-pill px-3 me-2">–°–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å</button>
                                            <button name="result" value=-1 type="submit"
                                                class="btn btn-sm btn-outline-danger rounded-pill px-3">–û—Ç–∫–ª.</button>
                                        </td>
                                    </form>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 4.3 –ó–ê–ü–†–û–°–´ –ù–ê –ü–û–ü–û–õ–ù–ï–ù–ò–ï –ë–ê–õ–ê–ù–°–ê -->
                <div class="tab-pane fade" id="balance-requests">
                    <h5 class="fw-bold mb-4">–ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</h5>

                    {% if balance_requests and balance_requests|length > 0 %}
                    <div class="d-flex flex-column gap-4">
                        {% for i in range(balance_requests|length - 1, -1, -1) %}
                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-4">
                                <div class="row g-4">
                                    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ë–æ–ª—å—à–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ –¥–ª—è —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤ -->
                                    <div class="col-md-5 col-lg-4">
                                        <div class="d-flex align-items-center justify-content-center h-100">
                                            <img src="{{ url_for('static', filename='images/screenshots/' + i|string + '.jpg') }}"
                                                alt="–°–∫—Ä–∏–Ω—à–æ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞" class="img-fluid rounded-3"
                                                style="max-width: 100%; max-height: 500px; object-fit: contain; border: 1px solid #dee2e6;">
                                        </div>
                                    </div>

                                    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                                    <div class="col-md-7 col-lg-8">
                                        <div class="d-flex flex-column h-100">
                                            <h5 class="fw-bold mb-4">–ó–∞–ø—Ä–æ—Å #{{ i + 1 }}</h5>

                                            <div class="mb-3">
                                                <small class="text-muted d-block">–ü–æ—á—Ç–∞:</small>
                                                <span class="fw-medium fs-6">{{ balance_requests[i].email }}</span>
                                            </div>

                                            <div class="mb-3">
                                                <small class="text-muted d-block">–§–ò–û:</small>
                                                <span class="fw-medium fs-6">{{ balance_requests[i].name }}</span>
                                            </div>

                                            <div class="mb-3">
                                                <small class="text-muted d-block">–¢–µ–ª–µ—Ñ–æ–Ω:</small>
                                                <span class="fw-medium fs-6">{{ balance_requests[i].phone }}</span>
                                            </div>

                                            <div class="mb-3">
                                                <small class="text-muted d-block">–ö–ª–∞—Å—Å –æ–±—É—á–µ–Ω–∏—è:</small>
                                                <span class="fw-medium fs-6">{{ balance_requests[i].grade }}</span>
                                            </div>

                                            <div class="mb-4">
                                                <small class="text-muted d-block">–°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è:</small>
                                                <span class="fw-bold text-primary fs-4">{{ balance_requests[i].amount }}
                                                    ‚ÇΩ</span>
                                            </div>

                                            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                                            {% if balance_requests[i].approved == 0 %}
                                            <div class="d-flex gap-3 mt-auto">
                                                <form action="{{ url_for('approve_balance_req', id=i) }}"
                                                    method="get" class="flex-fill">
                                                    <button type="submit" class="btn btn-success btn-lg w-100 py-2">
                                                        <i class="bi bi-check-lg me-2"></i>–û–¥–æ–±—Ä–∏—Ç—å
                                                    </button>
                                                </form>
                                                <form action="{{ url_for('decline_balance_req', id=i) }}"
                                                    method="get" class="flex-fill">
                                                    <button type="submit"
                                                        class="btn btn-outline-danger btn-lg w-100 py-2">
                                                        <i class="bi bi-x-lg me-2"></i>–û—Ç–∫–ª–æ–Ω–∏—Ç—å
                                                    </button>
                                                </form>
                                            </div>
                                            {% elif balance_requests[i].approved == 1 %}
                                            <div class="d-flex gap-3 mt-auto">
                                                <h4 class="text-success">–û–¥–æ–±—Ä–µ–Ω–æ</h4>
                                            </div>
                                            {% else %}
                                            <div class="d-flex gap-3 mt-auto">
                                                <h4 class="text-danger">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</h4>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <div class="bg-light rounded-3 p-5">
                            <i class="bi bi-cash-stack fs-1 text-muted opacity-25 mb-3"></i>
                            <h5 class="text-muted mb-2">–ù–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</h5>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- 4.4 –û–¢–ß–ï–¢–´ -->
                <div class="tab-pane fade" id="reports">
                    <h5 class="fw-bold mb-4">–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤</h5>
                    <div class="row g-4">
                        <!-- –ü–µ—Ä–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm p-4 h-100">
                                <div class="d-flex align-items-center gap-3 mb-3">
                                    <div class="bg-primary bg-opacity-10 text-primary p-3 rounded-circle">
                                        <i class="bi bi-file-earmark-spreadsheet fs-3"></i>
                                    </div>
                                    <div>
                                        <h6 class="fw-bold mb-0">–û—Ç—á–µ—Ç –ø–æ –∑–∞–∫–∞–∑–∞–º</h6>
                                        <small class="text-muted">–í—Å–µ –∑–∞–∫–∞–∑—ã —É—á–µ–Ω–∏–∫–æ–≤ –ø–æ–≤–∞—Ä–∞–º</small>
                                    </div>
                                </div>
                                <a href="{{ url_for('download_student_report') }}"
                                    class="btn btn-outline-primary btn-pill w-100 mt-auto">
                                    –°–∫–∞—á–∞—Ç—å Excel
                                </a>
                            </div>
                        </div>

                        <!-- –í—Ç–æ—Ä–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm p-4 h-100">
                                <div class="d-flex align-items-center gap-3 mb-3">
                                    <div class="bg-primary bg-opacity-10 text-primary p-3 rounded-circle">
                                        <i class="bi bi-file-earmark-spreadsheet fs-3"></i>
                                    </div>
                                    <div>
                                        <h6 class="fw-bold mb-0">–û—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∞–º</h6>
                                        <small class="text-muted">–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –∑–∞–∫—É–ø–∫—É –ø—Ä–æ–¥—É–∫—Ç–æ–≤</small>
                                    </div>
                                </div>
                                <a href="{{ url_for('download_product_report') }}"
                                    class="btn btn-outline-primary btn-pill w-100 mt-auto">
                                    –°–∫–∞—á–∞—Ç—å Excel
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    {%endif%}

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ –ê–¥–º–∏–Ω–∞
        document.addEventListener("DOMContentLoaded", function () {
            const ctx = document.getElementById('attendanceChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞'],
                        datasets: [{
                            label: '–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å',
                            data: [620, 640, 590, 650, 600],
                            backgroundColor: '#3b82f6',
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }
        });

        function downloadReport(name) {
            alert("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞: " + name + "...\n–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–Ω–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.");
        }
    </script>
    {% endif %}

    {% if rights == 2 %}
    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm" method="post" action="/update_inventory">
                        <input type="hidden" id="editProductName" name="product_name">

                        <div class="mb-3">
                            <label class="form-label small fw-bold">–¢–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                            <input type="number" class="form-control" id="editCurrentCount" name="current_count" min="0"
                                step="0.1">
                            <div class="form-text">–î–æ—Å—Ç—É–ø–Ω–æ: <span id="editMaxCount">0</span> <span
                                    id="editSuffix"></span></div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

</div>

{% endblock %}

{% block scripts %}
<script>
    // ============================================
    // –û–ë–©–ò–ï –°–ö–†–ò–ü–¢–´ (–î–ª—è –£—á–µ–Ω–∏–∫–∞ –∏ –ü–æ–≤–∞—Ä–∞)
    // ============================================

    // --- –£–ß–ï–ù–ò–ö: –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê ---
    function confirmOrder(btn) {
        if (confirm("–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø–æ–ª—É—á–∏–ª–∏ –µ–¥—É?")) {
            const card = document.getElementById('activeOrderCard');
            // –ú–µ–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –Ω–∞ —É—Å–ø–µ—Ö
            card.innerHTML = `<div class="d-flex align-items-center gap-3 text-success justify-content-center w-100"><i class="bi bi-check-circle-fill fs-3"></i><h5 class="mb-0">–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∞–ø–ø–µ—Ç–∏—Ç–∞!</h5></div>`;
            // –°–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => { card.style.display = 'none'; }, 3000);
        }
    }

    // --- –£–ß–ï–ù–ò–ö: –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ú–ï–ù–Æ ---
    document.addEventListener("DOMContentLoaded", function () {
        const checkboxes = document.querySelectorAll('.filter-checkbox');
        const allergySwitch = document.getElementById('allergyFilter');
        const items = document.querySelectorAll('.product-item');
        const noResults = document.getElementById('noResults');

        if (checkboxes.length > 0) {
            function filterProducts() {
                const activeCategories = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
                let visibleCount = 0;

                items.forEach(item => {
                    const itemCategory = item.getAttribute('data-category');
                    const isDangerous = item.getAttribute('data-allergen') === 'true';

                    const matchCategory = activeCategories.includes(itemCategory);
                    const matchAllergy = (allergySwitch && allergySwitch.checked) ? !isDangerous : true;

                    if (matchCategory && matchAllergy) {
                        item.classList.remove('d-none');
                        visibleCount++;
                    } else {
                        item.classList.add('d-none');
                    }
                });

                if (noResults) {
                    if (visibleCount === 0) noResults.classList.remove('d-none');
                    else noResults.classList.add('d-none');
                }
            }

            checkboxes.forEach(cb => cb.addEventListener('change', filterProducts));
            if (allergySwitch) allergySwitch.addEventListener('change', filterProducts);

            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            filterProducts();
        }
    });

    // --- –ü–û–í–ê–†: –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ö–õ–ê–î–ê ---
    document.addEventListener('DOMContentLoaded', function () {
        const editModal = document.getElementById('editModal');
        if (editModal) {
            editModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const productName = button.getAttribute('data-product-name');
                const currentCount = button.getAttribute('data-current-count');
                const maxCount = button.getAttribute('data-max-count');
                const suffix = button.getAttribute('data-suffix');

                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏
                document.getElementById('editProductName').value = productName;
                document.getElementById('editCurrentCount').value = currentCount;
                document.getElementById('editMaxCount').textContent = maxCount;
                document.getElementById('editSuffix').textContent = suffix;

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è input
                const inputField = document.getElementById('editCurrentCount');
                inputField.max = maxCount;
                inputField.setAttribute('placeholder', `–ú–∞–∫—Å: ${maxCount} ${suffix}`);
            });
        }
    });

    // ============================================
    // –°–û–•–†–ê–ù–ï–ù–ò–ï –ê–ö–¢–ò–í–ù–û–ô –í–ö–õ–ê–î–ö–ò –ü–†–ò –ü–ï–†–ï–ó–ê–ì–†–£–ó–ö–ï
    // ============================================

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
    function saveActiveTab(tabId) {
        const rights = {{ rights| tojson
    }}; // –ü—Ä–∞–≤–∞ –∏–∑ —à–∞–±–ª–æ–Ω–∞
    localStorage.setItem(`dashboard_tab_${rights}`, tabId);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
    function restoreActiveTab() {
        const rights = {{ rights| tojson
    }};
    let savedTabId = localStorage.getItem(`dashboard_tab_${rights}`);
    if (!savedTabId) {
        savedTabId = "begin";
    };

    // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É –≤–∫–ª–∞–¥–∫–∏ –ø–æ data-bs-target
    const tabButton = document.querySelector(`[data-bs-target="#${savedTabId}"]`);
    if (!tabButton) return;

    // –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –ø–∞–Ω–µ–ª—å
    const tabPane = document.querySelector(`#${savedTabId}`);
    if (!tabPane) return;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–∫—Ç–∏–≤–Ω–∞ –ª–∏ —É–∂–µ —ç—Ç–∞ –≤–∫–ª–∞–¥–∫–∞
    if (tabButton.classList.contains('active')) return;

    // –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º –≤—Å–µ transition –¥–ª—è —Ç–∞–±–æ–≤
    const allPanes = document.querySelectorAll('.tab-pane');
    allPanes.forEach(pane => {
        pane.classList.add('no-transition');
    });

    // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫ –∏ –ø–∞–Ω–µ–ª–µ–π
    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
        link.setAttribute('aria-selected', 'false');
    });

    document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('show', 'active');
    });

    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
    tabButton.classList.add('active');
    tabButton.setAttribute('aria-selected', 'true');

    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–∞–Ω–µ–ª—å –ú–û–ú–ï–ù–¢–ê–õ–¨–ù–û
    tabPane.classList.add('show', 'active');

    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º transition —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à–æ–π —Ç–∞–π–º–∞—É—Ç
    setTimeout(() => {
        allPanes.forEach(pane => {
            pane.classList.remove('no-transition');
        });
    }, 50);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ –ø–æ–≤–∞—Ä–∞
    document.addEventListener('DOMContentLoaded', function () {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        setTimeout(restoreActiveTab, 10); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ DOM

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É –ø—Ä–∏ –∫–ª–∏–∫–µ
        document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(button => {
            button.addEventListener('click', function () {
                const target = this.getAttribute('data-bs-target');
                if (target) {
                    const tabId = target.substring(1); // –£–±–∏—Ä–∞–µ–º —Å–∏–º–≤–æ–ª #
                    saveActiveTab(tabId);
                }
            });
        });

        // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ Bootstrap
        document.querySelectorAll('[data-bs-toggle="tab"]').forEach(element => {
            element.addEventListener('shown.bs.tab', function (event) {
                const target = event.target.getAttribute('data-bs-target');
                if (target) {
                    const tabId = target.substring(1);
                    saveActiveTab(tabId);
                }
            });
        });
    });

    // –î–ª—è —Ä–æ–ª–∏ –∞–¥–º–∏–Ω–∞ (rights == 3) - —Ç–µ –∂–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –Ω–æ –¥–ª—è –¥—Ä—É–≥–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
    // (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É, —Ç–∞–∫ –∫–∞–∫ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞)

    // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–æ–¥ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ –±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏
    (function () {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
        window.addEventListener('beforeunload', () => {
            sessionStorage.setItem('scrollY', window.pageYOffset);
        });

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ (—Å –∑–∞–¥–µ—Ä–∂–∫–æ–π)
        let scrollTimer;
        window.addEventListener('scroll', () => {
            clearTimeout(scrollTimer);
            scrollTimer = setTimeout(() => {
                sessionStorage.setItem('scrollY', window.pageYOffset);
            }, 150);
        });

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é (—Å—Ç—Ä–æ–≥–æ –±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏)
        document.addEventListener('DOMContentLoaded', () => {
            const savedY = sessionStorage.getItem('scrollY');
            if (savedY) {
                // –ö–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç: behavior: 'auto' –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ
                window.scrollTo(0, parseInt(savedY, 10)); // –ë–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏
            }
        });
    })();

    document.addEventListener('DOMContentLoaded', function () {
        const datepicker = document.getElementById('datepicker');

        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –∏ –¥–∞—Ç—É —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);

        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞—Ç—É –∑–∞–≤—Ç—Ä–∞ –≤ —Ñ–æ—Ä–º–∞—Ç YYYY-MM-DD
        const tomorrowStr = tomorrow.toISOString().split('T')[0];

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É –∫–∞–∫ –∑–∞–≤—Ç—Ä–∞
        datepicker.min = tomorrowStr;
        datepicker.value = tomorrowStr; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤—Ç—Ä–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
        datepicker.addEventListener('change', function () {
            const selectedDate = new Date(this.value);
            const todayWithoutTime = new Date(today.getFullYear(), today.getMonth(), today.getDate());

            if (selectedDate <= todayWithoutTime) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –Ω–∞—á–∏–Ω–∞—è —Å –∑–∞–≤—Ç—Ä–∞—à–Ω–µ–≥–æ –¥–Ω—è');
                this.value = tomorrowStr; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –∑–∞–≤—Ç—Ä–∞
            }
        });
    });

</script>

<style>
    .fade-in {
        animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .hover-primary:hover {
        background-color: #3b82f6 !important;
        border-color: #3b82f6 !important;
        color: white !important;
    }

    .tab-pane.no-transition {
        transition: none !important;
    }
</style>
{% endblock %}