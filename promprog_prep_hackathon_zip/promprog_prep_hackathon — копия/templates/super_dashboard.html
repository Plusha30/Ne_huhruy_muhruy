{% extends "base.html" %}
{% block title %}Ultimate Data Hub 2026{% endblock %}

{% block content %}
<div class="container-fluid px-4 pb-5">
    
    <!-- HEADER SECTION: Контроль состояния системы -->
    <div class="d-flex flex-wrap justify-content-between align-items-end mb-4 gap-3">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item small"><a href="/" class="text-muted text-decoration-none">Home</a></li>
                    <li class="breadcrumb-item small active">Analytics Hub</li>
                </ol>
            </nav>
            <h2 class="fw-bold mb-0">Platform <span class="text-gradient">Intelligence</span></h2>
        </div>
        <div class="d-flex align-items-center gap-3 bg-white p-2 px-3 rounded-pill shadow-sm border">
            <div class="position-relative">
                <span class="position-absolute top-50 start-50 translate-middle p-1 bg-success border border-light rounded-circle animate-ping"></span>
                <span class="d-inline-block p-1 bg-success border border-light rounded-circle"></span>
            </div>
            <span class="small fw-bold text-secondary">System Online: <span class="text-dark" id="live-timer">17:00:00</span></span>
            <div class="vr mx-2"></div>
            <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill">v2.1.0-stable</span>
        </div>
    </div>

    <!-- ROW 1: КЛЮЧЕВЫЕ МЕТРИКИ (DELTA CARDS) -->
    <div class="row g-4 mb-4">
        {% set metrics = [
            {'label': 'Total Revenue', 'val': '$84,200', 'up': True, 'perc': '14.2%', 'icon': 'wallet2', 'c': 'primary'},
            {'label': 'Active Sessions', 'val': '1,429', 'up': True, 'perc': '5.7%', 'icon': 'person-badge', 'c': 'success'},
            {'label': 'Server Load', 'val': '32.1%', 'up': False, 'perc': '2.4%', 'icon': 'cpu', 'c': 'warning'},
            {'label': 'API Latency', 'val': '124ms', 'up': True, 'perc': '0.3%', 'icon': 'speedometer', 'c': 'info'}
        ] %}
        {% for m in metrics %}
        <div class="col-xl-3 col-md-6">
            <div class="card card-hover border-0 shadow-sm p-3 h-100">
                <div class="d-flex justify-content-between mb-3">
                    <div class="bg-{{m.c}} bg-opacity-10 text-{{m.c}} rounded-3 p-2 px-3">
                        <i class="bi bi-{{m.icon}} fs-5"></i>
                    </div>
                    <span class="badge bg-{{ 'success' if m.up else 'danger' }} bg-opacity-10 text-{{ 'success' if m.up else 'danger' }} rounded-pill align-self-start">
                        {{ '+' if m.up else '-' }}{{ m.perc }}
                    </span>
                </div>
                <h6 class="text-muted small fw-bold text-uppercase mb-1">{{ m.label }}</h6>
                <h3 class="fw-bold mb-0">{{ m.val }}</h3>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- ROW 2: ГРАФИКИ (DATA VISUALIZATION) -->
    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="card card-hover border-0 shadow-sm p-4 h-100">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold mb-0">Performance Analytics</h5>
                    <select class="form-select form-select-sm w-auto border-0 bg-light rounded-pill">
                        <option>Last 30 Days (2026)</option>
                        <option>Current Week</option>
                    </select>
                </div>
                <div style="height: 300px;"><canvas id="mainChart"></canvas></div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card card-hover border-0 shadow-sm p-4 h-100 text-center">
                <h5 class="fw-bold mb-4">Traffic Distribution</h5>
                <div style="height: 220px;"><canvas id="pieChart"></canvas></div>
                <div class="mt-4 pt-2">
                    <div class="d-flex justify-content-between small mb-2">
                        <span><i class="bi bi-circle-fill text-primary me-2"></i>Desktop</span>
                        <span class="fw-bold">58%</span>
                    </div>
                    <div class="d-flex justify-content-between small">
                        <span><i class="bi bi-circle-fill text-info me-2"></i>Mobile</span>
                        <span class="fw-bold">42%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ROW 3: СЛОЖНАЯ ТАБЛИЦА (УПРАВЛЕНИЕ) -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="card card-hover border-0 shadow-sm overflow-hidden">
                <div class="card-header bg-white p-4 border-0 d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold mb-0">Active Project Deployments</h5>
                    <div class="d-flex gap-2">
                        <div class="input-group input-group-sm" style="width: 250px;">
                            <span class="input-group-text bg-light border-0"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control bg-light border-0" placeholder="Search service...">
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table align-middle table-hover mb-0">
                        <thead class="bg-light">
                            <tr class="small text-muted fw-bold">
                                <th class="ps-4">SERVICE</th>
                                <th>HEALTH</th>
                                <th>RESOURCES</th>
                                <th>TEAM</th>
                                <th class="text-end pe-4">ACTION</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for s in [
                                {'n': 'Core-API', 'v': 'v2.4', 'h': 'Healthy', 'c': 'success', 'p': 65},
                                {'n': 'Auth-Module', 'v': 'v1.9', 'h': 'Warning', 'c': 'warning', 'p': 88},
                                {'n': 'Payment-Gateway', 'v': 'v3.0', 'h': 'Healthy', 'c': 'success', 'p': 24}
                            ] %}
                            <tr>
                                <td class="ps-4">
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="bg-dark rounded-2 p-2 text-white"><i class="bi bi-cpu"></i></div>
                                        <div>
                                            <div class="fw-bold small">{{ s.n }}</div>
                                            <div class="text-muted" style="font-size: 0.7rem;">{{ s.v }} • 2026-01-22</div>
                                        </div>
                                    </div>
                                </td>
                                <td><span class="badge bg-{{s.c}} bg-opacity-10 text-{{s.c}} rounded-pill fw-normal">● {{ s.h }}</span></td>
                                <td style="width: 150px;">
                                    <div class="progress" style="height: 5px;"><div class="progress-bar bg-{{s.c}}" style="width: {{s.p}}%"></div></div>
                                </td>
                                <td>
                                    <div class="avatar-group d-flex">
                                        <img src="https://i.pravatar.cc{{s.n}}1" class="rounded-circle border border-2 border-white" width="28">
                                        <img src="https://i.pravatar.cc{{s.n}}2" class="rounded-circle border border-2 border-white" width="28" style="margin-left: -10px;">
                                    </div>
                                </td>
                                <td class="text-end pe-4"><button class="btn btn-sm btn-white border rounded-pill px-3">Manage</button></td>
                            </tr>
                            {% endfor %}
                            <tr class="opacity-50">
                                <td class="ps-4"><div class="skeleton" style="width: 100px; height: 14px;"></div></td>
                                <td><div class="skeleton" style="width: 60px; height: 14px;"></div></td>
                                <td><div class="skeleton" style="width: 120px; height: 14px;"></div></td>
                                <td><div class="skeleton rounded-circle" style="width: 25px; height: 25px;"></div></td>
                                <td><div class="skeleton ms-auto" style="width: 25px; height: 25px;"></div></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ROW 4: УТИЛИТАРНЫЕ ТАБЛИЦЫ И ИНСТРУМЕНТЫ -->
    <div class="row g-4">
        <!-- Краткий список -->
        <div class="col-lg-4">
            <div class="card card-hover border-0 shadow-sm p-4 h-100">
                <h6 class="fw-bold mb-4 text-uppercase small text-muted">Recent Events</h6>
                <div class="timeline">
                    {% for t in ['17:00', '16:45', '16:20'] %}
                    <div class="d-flex gap-3 pb-3 border-start ms-2 ps-3 position-relative">
                        <div class="position-absolute top-0 start-0 translate-middle-x bg-primary rounded-circle" style="width: 8px; height: 8px; margin-left: -1px;"></div>
                        <div class="small">
                            <div class="fw-bold">{{ ['Backup Done', 'User Joined', 'Update Published']|random }}</div>
                            <div class="text-muted">{{ t }} • Moscow, RU</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Упрощенная таблица логов -->
        <div class="col-lg-8">
            <div class="card card-hover border-0 shadow-sm overflow-hidden h-100">
                <div class="p-3 bg-light border-bottom d-flex justify-content-between align-items-center">
                    <span class="small fw-bold text-muted px-2">System Audit Trail</span>
                    <button class="btn btn-sm btn-white border px-3 btn-pill small">Export CSV</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <tbody class="small">
                            {% for i in range(5) %}
                            <tr>
                                <td class="ps-4 py-2 text-muted" style="width: 80px;">17:0{{i}}</td>
                                <td class="py-2"><span class="badge bg-{{ ['success','info','warning']|random }} p-1 me-2"></span> <strong>LOG-{{202+i}}</strong></td>
                                <td class="py-2 text-secondary">Operation completed successfully in 45ms.</td>
                                <td class="pe-4 text-end text-muted"><i class="bi bi-info-circle"></i></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- СТИЛИ -->
<style>
    .animate-ping { animation: ping 1.5s cubic-bezier(0, 0, 0.2, 1) infinite; }
    @keyframes ping { 75%, 100% { transform: translate(-50%, -50%) scale(2.5); opacity: 0; } }
    .skeleton { 
        background: linear-gradient(90deg, #f8f9fa 25%, #e9ecef 50%, #f8f9fa 75%);
        background-size: 200% 100%;
        animation: skeleton-loading 1.5s infinite;
        border-radius: 10px;
    }
    @keyframes skeleton-loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    .table-striped > tbody > tr:nth-of-type(odd) { --bs-table-accent-bg: rgba(var(--bs-primary-rgb), 0.015); }
    .avatar-group img { transition: transform 0.2s; cursor: pointer; }
    .avatar-group img:hover { transform: translateY(-3px); z-index: 10; }
</style>

<!-- ГРАФИКИ -->
<script src="https://cdn.jsdelivr.net"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Main Area Chart
    const ctxMain = document.getElementById('mainChart').getContext('2d');
    let grad = ctxMain.createLinearGradient(0, 0, 0, 300);
    grad.addColorStop(0, 'rgba(13, 110, 253, 0.15)');
    grad.addColorStop(1, 'rgba(13, 110, 253, 0)');

    new Chart(ctxMain, {
        type: 'line',
        data: {
            labels: ['Jan 16', 'Jan 17', 'Jan 18', 'Jan 19', 'Jan 20', 'Jan 21', 'Jan 22'],   // change
            datasets: [{
                label: 'Usage',
                data: [450, 590, 800, 720, 950, 1100, 1280],
                borderColor: '#0d6efd',
                backgroundColor: grad,
                fill: true,
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 0,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { grid: { borderDash: [5, 5], drawBorder: false }, ticks: { font: { size: 11 } } },
                x: { grid: { display: false }, ticks: { font: { size: 11 } } }
            }
        }
    });

    // Pie Chart
    new Chart(document.getElementById('pieChart'), {
        type: 'doughnut',
        data: {
            labels: ['Desktop', 'Mobile'],
            datasets: [{
                data: [58, 42],
                backgroundColor: ['#0d6efd', '#0dcaf0'],
                borderWidth: 0,
                cutout: '85%'
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });

    // Live Timer
    setInterval(() => {
        document.getElementById('live-timer').innerText = new Date().toLocaleTimeString();
    }, 1000);
});
</script>
{% endblock %}