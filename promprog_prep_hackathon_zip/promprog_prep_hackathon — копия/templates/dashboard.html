{% extends "base.html" %}
{% block title %}
{% if rights == 2 %}–†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ –ø–æ–≤–∞—Ä–∞{% elif rights == 3 %}–ö–∞–±–∏–Ω–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞{% else %}–ú–µ–Ω—é —Å—Ç–æ–ª–æ–≤–æ–π{% endif %}
{% endblock %}

{% block content %}
<div class="container pb-5">

    <!-- ============================================== -->
    <!-- 1. –ó–ê–ì–û–õ–û–í–û–ö –°–¢–†–ê–ù–ò–¶–´ (–û–ë–©–ò–ô)                  -->
    <!-- ============================================== -->
    <div class="d-flex flex-wrap justify-content-between align-items-end mb-5 gap-3">
        <div>
            <h1 class="fw-bold mb-1">
                {% if rights == 0 %}–ú–µ–Ω—é —Å—Ç–æ–ª–æ–≤–æ–π üçΩÔ∏è{% endif %}
                {% if rights == 1 %}–ü—Ä–∏–≤–µ—Ç, {{ username }}! üëã{% endif %}
                {% if rights == 2 %}–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—É—Ö–Ω–µ–π üë®‚Äçüç≥{% endif %}
                {% if rights == 3 %}–ö–∞–±–∏–Ω–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ üëî{% endif %}
            </h1>
            <p class="text-secondary mb-0">
                {% if rights == 0 %}–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑.{% endif %}
                {% if rights == 1 %}–¢–≤–æ–π –±–∞–ª–∞–Ω—Å: <span class="fw-bold text-success">{{ money }} ‚ÇΩ</span>{% endif %}
                {% if rights == 2 %}–£—á–µ—Ç –≤—ã–¥–∞—á–∏ –±–ª—é–¥, –∫–æ–Ω—Ç—Ä–æ–ª—å —Å–∫–ª–∞–¥–∞ –∏ –∑–∞–∫—É–ø–∫–∏.{% endif %}
                {% if rights == 3 %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–æ–∫ –∏ –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å.{% endif %}
            </p>
        </div>

        <!-- –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô -->
        {% if rights == 1 %}
        <div class="d-flex gap-2">
            <a href="{{ url_for('pricing') }}" class="btn btn-primary-custom btn-pill shadow-sm">
                <i class="bi bi-wallet2 me-2"></i>–ü–æ–ø–æ–ª–Ω–∏—Ç—å
            </a>
        </div>
        {% endif %}
        {% if rights == 0 %}
        <div class="d-flex gap-2">
            <a href="{{ url_for('login') }}" class="btn btn-primary-custom btn-pill shadow-sm">
                –í–æ–π—Ç–∏ –¥–ª—è –∑–∞–∫–∞–∑–∞
            </a>
        </div>
        {% endif %}
    </div>

    <!-- ============================================== -->
    <!-- 2. –†–û–õ–¨: –£–ß–ï–ù–ò–ö (1) –ò –ì–û–°–¢–¨ (0) - –ú–ï–ù–Æ         -->
    <!-- ============================================== -->
    {% if rights == 1 or rights == 0 %}

    <!-- –ë–ª–æ–∫ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ (–¢–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —É—á–µ–Ω–∏–∫–∞) -->
    {% if rights == 1 %}
    <div class="card border-0 shadow-sm p-4 mb-5" id="activeOrderCard">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div class="d-flex align-items-center gap-3">
                <div class="bg-warning bg-opacity-10 text-warning p-3 rounded-circle">
                    <i class="bi bi-clock-history fs-4"></i>
                </div>
                <div>
                    <h5 class="fw-bold mb-0">–í–∞—à –∑–∞–∫–∞–∑ –≥–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ!</h5>
                    <p class="text-muted small mb-0">–ó–∞–∫–∞–∑ ‚Ññ482: –ë–æ—Ä—â, –ö–æ–º–ø–æ—Ç.</p>
                </div>
            </div>
            <button onclick="confirmOrder(this)" class="btn btn-success btn-pill px-4">
                <i class="bi bi-qr-code me-2"></i>–Ø –ø–æ–ª—É—á–∏–ª –µ–¥—É
            </button>
        </div>
    </div>
    {% endif %}

    <div class="row g-4">
        <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –§–ò–õ–¨–¢–†–´ -->
        <div class="col-lg-3">
            <div class="filters-sidebar shadow-sm sticky-top" style="top: 100px;">

                <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
                <div class="mb-4">
                    <span class="filter-group-title">–ö–ê–¢–ï–ì–û–†–ò–ò</span>
                    <div class="d-flex flex-column gap-2">
                        <div class="form-check">
                            <input class="form-check-input filter-checkbox" type="checkbox" value="–ü–µ—Ä–≤–æ–µ" checked id="c1">
                            <label class="form-check-label cursor-pointer" for="c1">–ü–µ—Ä–≤–æ–µ</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input filter-checkbox" type="checkbox" value="–í—Ç–æ—Ä–æ–µ" checked id="c2">
                            <label class="form-check-label cursor-pointer" for="c2">–í—Ç–æ—Ä–æ–µ</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input filter-checkbox" type="checkbox" value="–ù–∞–ø–∏—Ç–∫–∏" checked id="c3">
                            <label class="form-check-label cursor-pointer" for="c3">–ù–∞–ø–∏—Ç–∫–∏</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input filter-checkbox" type="checkbox" value="–°–∞–ª–∞—Ç—ã" checked id="c4">
                            <label class="form-check-label cursor-pointer" for="c4">–°–∞–ª–∞—Ç—ã</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input filter-checkbox" type="checkbox" value="–§—Ä—É–∫—Ç—ã" checked id="c5">
                            <label class="form-check-label cursor-pointer" for="c5">–§—Ä—É–∫—Ç—ã</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input filter-checkbox" type="checkbox" value="–í—ã–ø–µ—á–∫–∞" checked id="c6">
                            <label class="form-check-label cursor-pointer" for="c6">–í—ã–ø–µ—á–∫–∞</label>
                        </div>
                    </div>
                </div>

                <!-- –§–∏–ª—å—Ç—Ä –∑–¥–æ—Ä–æ–≤—å—è -->
                <div class="mb-4">
                    <span class="filter-group-title">–ó–î–û–†–û–í–¨–ï</span>
                    <div class="form-check form-switch">
                        <!-- –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –∞–ª–ª–µ—Ä–≥–∏–∏, –≤–∫–ª—é—á–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é -->
                        <input class="form-check-input" type="checkbox" id="allergyFilter" {% if allergies %}checked{% endif %}>
                        <label class="form-check-label fw-bold" for="allergyFilter">–°–∫—Ä—ã—Ç—å –∞–ª–ª–µ—Ä–≥–µ–Ω—ã</label>
                    </div>
                </div>

                <!-- –°–ø–∏—Å–æ–∫ –∞–ª–ª–µ—Ä–≥–µ–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
                {% if rights == 1 %}
                <div class="p-3 bg-light rounded-3 border">
                    <small class="fw-bold text-muted">–í–∞—à–∏ –∞–ª–ª–µ—Ä–≥–µ–Ω—ã:</small>
                    <div class="d-flex gap-1 flex-wrap mt-2">
                        {% if allergies %}
                        {% for alg in allergies %}
                        <span class="badge bg-danger bg-opacity-10 text-danger border border-danger">{{ alg }}</span>
                        {% endfor %}
                        {% else %}
                        <span class="text-muted small">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
                        {% endif %}
                    </div>
                    <a href="{{ url_for('profile') }}" class="d-block small text-primary text-decoration-none mt-2">–ò–∑–º–µ–Ω–∏—Ç—å –≤ –ø—Ä–æ—Ñ–∏–ª–µ</a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –°–ï–¢–ö–ê –¢–û–í–ê–†–û–í -->
        <div class="col-lg-9">
            <div class="row g-4" id="productsGrid">
                {% if tovarlist %}
                {% for id, item in tovarlist.items() %}

                <!-- –ü–†–û–í–ï–†–ö–ê –ê–õ–õ–ï–†–ì–ò–ô -->
                <!-- –°–æ–∑–¥–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é namespace –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ —Ü–∏–∫–ª–∞ -->
                {% set ns = namespace(is_dangerous=false, danger_reason="") %}

                <!-- –ï—Å–ª–∏ —É —É—á–µ–Ω–∏–∫–∞ –µ—Å—Ç—å —Å–ø–∏—Å–æ–∫ –∞–ª–ª–µ—Ä–≥–∏–π –∏ —É —Ç–æ–≤–∞—Ä–∞ –µ—Å—Ç—å —Å–ø–∏—Å–æ–∫ –∞–ª–ª–µ—Ä–≥–µ–Ω–æ–≤ -->
                {% if allergies and item.allergens %}
                {% for prod_allergen in item.allergens %}
                <!-- –ï—Å–ª–∏ –∞–ª–ª–µ—Ä–≥–µ–Ω –ø—Ä–æ–¥—É–∫—Ç–∞ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ –∞–ª–ª–µ—Ä–≥–∏–π —É—á–µ–Ω–∏–∫–∞ -->
                {% if prod_allergen in allergies %}
                {% set ns.is_dangerous = true %}
                {% set ns.danger_reason = prod_allergen %}
                {% endif %}
                {% endfor %}
                {% endif %}

                <!-- data-allergen="true" –µ—Å–ª–∏ –æ–ø–∞—Å–Ω–æ -->
                <div class="col-md-4 col-sm-6 product-item"
                     data-category="{{ item.category }}"
                     data-allergen="{{ 'true' if ns.is_dangerous else 'false' }}">

                    <a href="{{ url_for('product_detail', id=id) }}" class="card-link h-100">
                        <div class="product-card h-100 d-flex flex-column position-relative">

                            <!-- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ–± –∞–ª–ª–µ—Ä–≥–∏–∏ (—Å–∫—Ä—ã—Ç–æ JS, –µ—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä –≤–∫–ª—é—á–µ–Ω) -->
                            {% if ns.is_dangerous %}
                            <div class="position-absolute top-0 start-0 w-100 h-100 bg-white bg-opacity-75 d-flex align-items-center justify-content-center danger-overlay" style="z-index: 10; display: none;">
                                    <span class="badge bg-danger fs-6 shadow">
                                        <i class="bi bi-exclamation-triangle-fill me-1"></i> –°–æ–¥–µ—Ä–∂–∏—Ç: {{ ns.danger_reason }}
                                    </span>
                            </div>
                            {% endif %}

                            <div class="product-img-wrapper" style="height: 180px;">
                                {% if item.badge %}
                                <span class="product-badge text-white" style="background-color: {{ item.color }};">{{ item.badge }}</span>
                                {% endif %}
                                <i class="bi {{ item.main_icon }}" style="font-size: 4rem; color: {{ item.color }}; opacity: 0.7;"></i>
                            </div>

                            <div class="p-3 d-flex flex-column flex-grow-1">
                                <div class="text-muted small mb-1">{{ item.category }}</div>
                                <h6 class="fw-bold mb-2 text-dark">{{ item.name }}</h6>

                                <!-- –°–ø–∏—Å–æ–∫ –∞–ª–ª–µ—Ä–≥–µ–Ω–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ -->
                                {% if item.allergens %}
                                <div class="mb-2">
                                    {% for alg in item.allergens %}
                                    {% if alg in allergies %}
                                    <span class="badge bg-danger bg-opacity-10 text-danger border border-danger" style="font-size: 0.65rem;">{{ alg }}</span>
                                    {% else %}
                                    <span class="badge bg-light text-secondary border" style="font-size: 0.65rem;">{{ alg }}</span>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                                {% endif %}

                                <div class="mt-auto d-flex justify-content-between align-items-center">
                                    <span class="fw-bold text-primary fs-5">{{ item.price }} ‚ÇΩ</span>
                                    {% if rights == 1 %}
                                    <span class="btn btn-sm btn-light border rounded-circle shadow-sm"><i class="bi bi-plus-lg"></i></span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
                {% endfor %}
                {% else %}
                <div class="col-12 text-center py-5">
                    <h4 class="text-muted">–ú–µ–Ω—é –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–ª–∏ –ø—É—Å—Ç–æ...</h4>
                </div>
                {% endif %}
            </div>

            <!-- –°–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ -->
            <div id="noResults" class="text-center py-5 d-none">
                <i class="bi bi-search fs-1 text-muted opacity-25"></i>
                <p class="text-muted mt-3">–ù–µ—Ç –±–ª—é–¥, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–∞–º.</p>
            </div>
        </div>
    </div>
    {% endif %}


    <!-- ============================================== -->
    <!-- 3. –†–û–õ–¨ 2: –ü–û–í–ê–† / –°–û–¢–†–£–î–ù–ò–ö                   -->
    <!-- ============================================== -->
    {% if rights == 2 %}

    <!-- KPI –ö–ê–†–¢–û–ß–ö–ò -->
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm p-3 h-100">
                <div class="d-flex align-items-center gap-3">
                    <div class="bg-success bg-opacity-10 text-success p-3 rounded-3"><i class="bi bi-check2-circle"></i></div>
                    <div>
                        <h3 class="fw-bold mb-0">142</h3>
                        <small class="text-muted">–ü–æ—Ä—Ü–∏–π –≤—ã–¥–∞–Ω–æ —Å–µ–≥–æ–¥–Ω—è</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm p-3 h-100">
                <div class="d-flex align-items-center gap-3">
                    <div class="bg-warning bg-opacity-10 text-warning p-3 rounded-3"><i class="bi bi-clock-history"></i></div>
                    <div>
                        <h3 class="fw-bold mb-0">15</h3>
                        <small class="text-muted">–û–∂–∏–¥–∞—é—Ç –≤—ã–¥–∞—á–∏</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm p-3 h-100">
                <div class="d-flex align-items-center gap-3">
                    <div class="bg-danger bg-opacity-10 text-danger p-3 rounded-3"><i class="bi bi-exclamation-triangle"></i></div>
                    <div>
                        <h3 class="fw-bold mb-0">2</h3>
                        <small class="text-muted">–ú–∞–ª—ã–π –æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –¢–ê–ë–´ –ü–û–í–ê–†–ê -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-bottom pt-3 px-4">
            <ul class="nav nav-tabs card-header-tabs" id="cookTabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active fw-bold text-dark" data-bs-toggle="tab" data-bs-target="#orders">
                        <i class="bi bi-list-check me-2"></i>–í—ã–¥–∞—á–∞ –±–ª—é–¥
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link text-secondary" data-bs-toggle="tab" data-bs-target="#inventory">
                        <i class="bi bi-box-seam me-2"></i>–°–∫–ª–∞–¥ –∏ –û—Å—Ç–∞—Ç–∫–∏
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link text-secondary" data-bs-toggle="tab" data-bs-target="#requests">
                        <i class="bi bi-cart-plus me-2"></i>–ó–∞—è–≤–∫–∞ –Ω–∞ –∑–∞–∫—É–ø–∫—É
                    </button>
                </li>
            </ul>
        </div>

        <div class="card-body p-4">
            <div class="tab-content">

                <!-- 3.1 –í–´–î–ê–ß–ê -->
                <div class="tab-pane fade show active" id="orders">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold mb-0">–¢–µ–∫—É—â–∞—è –æ—á–µ—Ä–µ–¥—å</h5>
                        <div class="input-group w-auto">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control bg-light border-start-0" placeholder="–ü–æ–∏—Å–∫ —É—á–µ–Ω–∏–∫–∞...">
                        </div>
                    </div>
                    <div class="table-modern-container">
                        <table class="table-modern">
                            <thead>
                            <tr>
                                <th class="ps-4">–£—á–µ–Ω–∏–∫</th>
                                <th>–ö–ª–∞—Å—Å</th>
                                <th>–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞</th>
                                <th>–í—Ä–µ–º—è</th>
                                <th class="text-end pe-4">–î–µ–π—Å—Ç–≤–∏–µ</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr id="order-101">
                                <td class="ps-4 fw-bold">–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤</td>
                                <td><span class="badge bg-light text-dark border">7 "–ë"</span></td>
                                <td>–ë–æ—Ä—â –ú–æ—Å–∫–æ–≤—Å–∫–∏–π, –ß–∞–π</td>
                                <td class="text-muted small">12:30</td>
                                <td class="text-end pe-4">
                                    <button onclick="issueOrder('101')" class="btn btn-sm btn-primary-custom btn-pill px-3">–í—ã–¥–∞—Ç—å</button>
                                </td>
                            </tr>
                            <tr id="order-102">
                                <td class="ps-4 fw-bold">–ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞</td>
                                <td><span class="badge bg-light text-dark border">5 "–ê"</span></td>
                                <td>–ö–æ—Ç–ª–µ—Ç–∞ —Å –ø—é—Ä–µ, –°–∞–ª–∞—Ç</td>
                                <td class="text-muted small">12:32</td>
                                <td class="text-end pe-4">
                                    <button onclick="issueOrder('102')" class="btn btn-sm btn-primary-custom btn-pill px-3">–í—ã–¥–∞—Ç—å</button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 3.2 –°–ö–õ–ê–î -->
                <div class="tab-pane fade" id="inventory">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="border rounded-3 p-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="fw-bold">–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å (–∫–≥)</span>
                                    <span class="badge bg-success bg-opacity-10 text-success">–ù–æ—Ä–º–∞</span>
                                </div>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-success" style="width: 75%"></div>
                                </div>
                                <small class="text-muted">–û—Å—Ç–∞—Ç–æ–∫: 150 –∫–≥ –∏–∑ 200 –∫–≥</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border rounded-3 p-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="fw-bold">–ú–æ–ª–æ–∫–æ (–ª)</span>
                                    <span class="badge bg-danger bg-opacity-10 text-danger">–ú–∞–ª–æ!</span>
                                </div>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-danger" style="width: 15%"></div>
                                </div>
                                <small class="text-muted">–û—Å—Ç–∞—Ç–æ–∫: 8 –ª –∏–∑ 50 –ª</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border rounded-3 p-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="fw-bold">–ú—è—Å–æ / –ì–æ–≤—è–¥–∏–Ω–∞ (–∫–≥)</span>
                                    <span class="badge bg-warning bg-opacity-10 text-warning text-dark">–ó–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è</span>
                                </div>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-warning" style="width: 30%"></div>
                                </div>
                                <small class="text-muted">–û—Å—Ç–∞—Ç–æ–∫: 12 –∫–≥ –∏–∑ 40 –∫–≥</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border rounded-3 p-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="fw-bold">–•–ª–µ–± (–±—É—Ö–∞–Ω–∫–∏)</span>
                                    <span class="badge bg-success bg-opacity-10 text-success">–ù–æ—Ä–º–∞</span>
                                </div>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-success" style="width: 90%"></div>
                                </div>
                                <small class="text-muted">–û—Å—Ç–∞—Ç–æ–∫: 90 —à—Ç</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3.3 –ó–ê–Ø–í–ö–ò -->
                <div class="tab-pane fade" id="requests">
                    <div class="row">
                        <div class="col-lg-5 mb-4 mb-lg-0">
                            <div class="bg-light p-4 rounded-4">
                                <h5 class="fw-bold mb-3">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</h5>
                                <form id="purchaseForm" onsubmit="submitPurchase(event)">
                                    <div class="mb-3">
                                        <label class="form-label small fw-bold text-muted">–ü—Ä–æ–¥—É–∫—Ç</label>
                                        <select class="form-select rounded-3" id="prodSelect">
                                            <option>–ú–æ–ª–æ–∫–æ</option>
                                            <option>–ú—É–∫–∞</option>
                                            <option>–°–∞—Ö–∞—Ä</option>
                                            <option>–ú—è—Å–æ</option>
                                            <option>–û–≤–æ—â–∏ (—Å–µ–∑–æ–Ω–Ω—ã–µ)</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label small fw-bold text-muted">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–∫–≥/–ª/—à—Ç)</label>
                                        <input type="number" class="form-control rounded-3" id="prodAmount" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 50" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label small fw-bold text-muted">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                                        <textarea class="form-control rounded-3" rows="2" placeholder="–°—Ä–æ—á–Ω–æ –∫ —Å—Ä–µ–¥–µ..."></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary-custom btn-pill w-100">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É</button>
                                </form>
                            </div>
                        </div>

                        <div class="col-lg-7">
                            <h5 class="fw-bold mb-3">–ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫</h5>
                            <div class="list-group list-group-flush" id="requestsList">
                                <div class="list-group-item px-0 border-bottom d-flex justify-content-between align-items-center">
                                    <div><h6 class="fw-bold mb-0">–ú–æ–ª–æ–∫–æ (50 –ª)</h6><small class="text-muted">10 –º–∏–Ω –Ω–∞–∑–∞–¥</small></div>
                                    <span class="badge bg-secondary bg-opacity-10 text-secondary">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</span>
                                </div>
                                <div class="list-group-item px-0 border-bottom d-flex justify-content-between align-items-center">
                                    <div><h6 class="fw-bold mb-0">–ú—è—Å–æ / –ì–æ–≤—è–¥–∏–Ω–∞ (30 –∫–≥)</h6><small class="text-muted">–í—á–µ—Ä–∞</small></div>
                                    <span class="badge bg-success bg-opacity-10 text-success">–û–¥–æ–±—Ä–µ–Ω–æ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    {% endif %}


    <!-- ============================================== -->
    <!-- 4. –†–û–õ–¨ 3: –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†                   -->
    <!-- ============================================== -->
    {% if rights == 3 %}

    <!-- –¢–ê–ë–´ –ê–î–ú–ò–ù–ê -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-bottom pt-3 px-4">
            <ul class="nav nav-tabs card-header-tabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active fw-bold text-dark" data-bs-toggle="tab" data-bs-target="#stats">
                        <i class="bi bi-bar-chart-fill me-2"></i>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link text-secondary" data-bs-toggle="tab" data-bs-target="#admin-requests">
                        <i class="bi bi-inbox-fill me-2"></i>–ó–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–∫—É–ø–∫—É <span class="badge bg-danger rounded-circle ms-1">2</span>
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link text-secondary" data-bs-toggle="tab" data-bs-target="#reports">
                        <i class="bi bi-file-earmark-text-fill me-2"></i>–û—Ç—á–µ—Ç—ã
                    </button>
                </li>
            </ul>
        </div>

        <div class="card-body p-4">
            <div class="tab-content">

                <!-- 4.1 –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
                <div class="tab-pane fade show active" id="stats">
                    <!-- KPI Cards -->
                    <div class="row g-4 mb-4">
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm p-4 bg-light">
                                <h6 class="text-muted text-uppercase small fw-bold">–í—ã—Ä—É—á–∫–∞ –∑–∞ –¥–µ–Ω—å</h6>
                                <h2 class="fw-bold text-primary mb-0">45 200 ‚ÇΩ</h2>
                                <small class="text-success fw-bold">+12% –∫ –≤—á–µ—Ä–∞</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm p-4 bg-light">
                                <h6 class="text-muted text-uppercase small fw-bold">–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</h6>
                                <h2 class="fw-bold text-dark mb-0">85%</h2>
                                <small class="text-muted">640 –∏–∑ 750 —É—á–µ–Ω–∏–∫–æ–≤</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm p-4 bg-light">
                                <h6 class="text-muted text-uppercase small fw-bold">–¢–æ–ø –±–ª—é–¥–æ</h6>
                                <h2 class="fw-bold text-danger mb-0">–ë–æ—Ä—â</h2>
                                <small class="text-muted">–ü—Ä–æ–¥–∞–Ω–æ 180 –ø–æ—Ä—Ü–∏–π</small>
                            </div>
                        </div>
                    </div>

                    <!-- –ì—Ä–∞—Ñ–∏–∫ -->
                    <div class="card border-0 shadow-sm p-4">
                        <h5 class="fw-bold mb-4">–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ (–Ω–µ–¥–µ–ª—è)</h5>
                        <div style="height: 300px;">
                            <canvas id="attendanceChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 4.2 –°–û–ì–õ–ê–°–û–í–ê–ù–ò–ï –ó–ê–ö–£–ü–û–ö -->
                <div class="tab-pane fade" id="admin-requests">
                    <h5 class="fw-bold mb-3">–ó–∞—è–≤–∫–∏ –æ—Ç –∫—É—Ö–Ω–∏</h5>
                    <div class="table-modern-container">
                        <table class="table-modern">
                            <thead>
                            <tr>
                                <th class="ps-4">–ü—Ä–æ–¥—É–∫—Ç</th>
                                <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                <th>–ü–æ–≤–∞—Ä</th>
                                <th>–î–∞—Ç–∞</th>
                                <th class="text-end pe-4">–†–µ—à–µ–Ω–∏–µ</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr id="req-1">
                                <td class="ps-4 fw-bold">–ú–æ–ª–æ–∫–æ 3.2%</td>
                                <td>50 –ª</td>
                                <td>–ü–µ—Ç—Ä–æ–≤ –í.–í.</td>
                                <td class="text-muted small">–°–µ–≥–æ–¥–Ω—è, 09:00</td>
                                <td class="text-end pe-4">
                                    <button onclick="approveRequest('req-1')" class="btn btn-sm btn-success rounded-pill px-3 me-2">–°–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å</button>
                                    <button onclick="rejectRequest('req-1')" class="btn btn-sm btn-outline-danger rounded-pill px-3">–û—Ç–∫–ª.</button>
                                </td>
                            </tr>
                            <tr id="req-2">
                                <td class="ps-4 fw-bold">–ì–æ–≤—è–¥–∏–Ω–∞ (–≤—ã—Ä–µ–∑–∫–∞)</td>
                                <td>30 –∫–≥</td>
                                <td>–ü–µ—Ç—Ä–æ–≤ –í.–í.</td>
                                <td class="text-muted small">–í—á–µ—Ä–∞</td>
                                <td class="text-end pe-4">
                                    <button onclick="approveRequest('req-2')" class="btn btn-sm btn-success rounded-pill px-3 me-2">–°–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å</button>
                                    <button onclick="rejectRequest('req-2')" class="btn btn-sm btn-outline-danger rounded-pill px-3">–û—Ç–∫–ª.</button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 4.3 –û–¢–ß–ï–¢–´ -->
                <div class="tab-pane fade" id="reports">
                    <h5 class="fw-bold mb-4">–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤</h5>
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm p-4 h-100">
                                <div class="d-flex align-items-center gap-3 mb-3">
                                    <div class="bg-primary bg-opacity-10 text-primary p-3 rounded-circle">
                                        <i class="bi bi-file-earmark-spreadsheet fs-3"></i>
                                    </div>
                                    <div>
                                        <h6 class="fw-bold mb-0">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç</h6>
                                        <small class="text-muted">–î–æ—Ö–æ–¥—ã –∏ —Ä–∞—Å—Ö–æ–¥—ã –∑–∞ –º–µ—Å—è—Ü</small>
                                    </div>
                                </div>
                                <button onclick="downloadReport('–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç')" class="btn btn-outline-primary btn-pill w-100 mt-auto">–°–∫–∞—á–∞—Ç—å Excel</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm p-4 h-100">
                                <div class="d-flex align-items-center gap-3 mb-3">
                                    <div class="bg-success bg-opacity-10 text-success p-3 rounded-circle">
                                        <i class="bi bi-file-earmark-pdf fs-3"></i>
                                    </div>
                                    <div>
                                        <h6 class="fw-bold mb-0">–û—Ç—á–µ—Ç –ø–æ –ø–∏—Ç–∞–Ω–∏—é</h6>
                                        <small class="text-muted">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–¥–∞–Ω–Ω—ã—Ö –ø–æ—Ä—Ü–∏–π –∏ –ª—å–≥–æ—Ç–Ω–∏–∫–∏</small>
                                    </div>
                                </div>
                                <button onclick="downloadReport('–û—Ç—á–µ—Ç –ø–æ –ø–∏—Ç–∞–Ω–∏—é')" class="btn btn-outline-success btn-pill w-100 mt-auto">–°–∫–∞—á–∞—Ç—å PDF</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ –ê–¥–º–∏–Ω–∞
        document.addEventListener("DOMContentLoaded", function() {
            const ctx = document.getElementById('attendanceChart');
            if(ctx) {
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞'],
                        datasets: [{
                            label: '–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å',
                            data: [620, 640, 590, 650, 600],
                            backgroundColor: '#3b82f6',
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }
        });

        // –§—É–Ω–∫—Ü–∏–∏ –ê–¥–º–∏–Ω–∞
        function approveRequest(id) {
            const row = document.getElementById(id);
            row.style.backgroundColor = "#dcfce7";
            const cell = row.querySelector('.text-end');
            cell.innerHTML = '<span class="text-success fw-bold"><i class="bi bi-check-lg"></i> –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ</span>';
        }

        function rejectRequest(id) {
            const row = document.getElementById(id);
            row.style.opacity = "0.5";
            const cell = row.querySelector('.text-end');
            cell.innerHTML = '<span class="text-danger fw-bold">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</span>';
        }

        function downloadReport(name) {
            alert("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞: " + name + "...\n–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–Ω–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.");
        }
    </script>
    {% endif %}

</div>

{% endblock %}

{% block scripts %}
<script>
    // ============================================
    // –û–ë–©–ò–ï –°–ö–†–ò–ü–¢–´ (–î–ª—è –£—á–µ–Ω–∏–∫–∞ –∏ –ü–æ–≤–∞—Ä–∞)
    // ============================================

    // --- –£–ß–ï–ù–ò–ö: –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê ---
    function confirmOrder(btn) {
        if(confirm("–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø–æ–ª—É—á–∏–ª–∏ –µ–¥—É?")) {
            const card = document.getElementById('activeOrderCard');
            // –ú–µ–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –Ω–∞ —É—Å–ø–µ—Ö
            card.innerHTML = `<div class="d-flex align-items-center gap-3 text-success justify-content-center w-100"><i class="bi bi-check-circle-fill fs-3"></i><h5 class="mb-0">–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∞–ø–ø–µ—Ç–∏—Ç–∞!</h5></div>`;
            // –°–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => { card.style.display = 'none'; }, 3000);
        }
    }

    // --- –£–ß–ï–ù–ò–ö: –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ú–ï–ù–Æ ---
    document.addEventListener("DOMContentLoaded", function() {
        const checkboxes = document.querySelectorAll('.filter-checkbox');
        const allergySwitch = document.getElementById('allergyFilter');
        const items = document.querySelectorAll('.product-item');
        const noResults = document.getElementById('noResults');

        if(checkboxes.length > 0) {
            function filterProducts() {
                const activeCategories = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
                let visibleCount = 0;

                items.forEach(item => {
                    const itemCategory = item.getAttribute('data-category');
                    const isDangerous = item.getAttribute('data-allergen') === 'true';

                    const matchCategory = activeCategories.includes(itemCategory);
                    const matchAllergy = (allergySwitch && allergySwitch.checked) ? !isDangerous : true;

                    if (matchCategory && matchAllergy) {
                        item.classList.remove('d-none');
                        visibleCount++;
                    } else {
                        item.classList.add('d-none');
                    }
                });

                if (noResults) {
                    if (visibleCount === 0) noResults.classList.remove('d-none');
                    else noResults.classList.add('d-none');
                }
            }

            checkboxes.forEach(cb => cb.addEventListener('change', filterProducts));
            if(allergySwitch) allergySwitch.addEventListener('change', filterProducts);

            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            filterProducts();
        }
    });

    // --- –ü–û–í–ê–†: –í–´–î–ê–ß–ê –ò –ó–ê–Ø–í–ö–ò ---
    function issueOrder(id) {
        const row = document.getElementById('order-' + id);
        const btn = row.querySelector('button');
        btn.className = "btn btn-sm btn-success rounded-pill px-3";
        btn.innerHTML = '<i class="bi bi-check2"></i> –í—ã–¥–∞–Ω–æ';
        btn.disabled = true;
        row.style.opacity = '0.6';
        alert("–ó–∞–∫–∞–∑ " + id + " –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –≤—ã–¥–∞–Ω–Ω—ã–π!");
    }

    function submitPurchase(e) {
        e.preventDefault();
        const prod = document.getElementById('prodSelect').value;
        const amount = document.getElementById('prodAmount').value;
        const list = document.getElementById('requestsList');

        const newItem = document.createElement('div');
        newItem.className = "list-group-item px-0 border-bottom d-flex justify-content-between align-items-center fade-in";
        newItem.innerHTML = `<div><h6 class="fw-bold mb-0">${prod} (${amount})</h6><small class="text-muted">–¢–æ–ª—å–∫–æ —á—Ç–æ</small></div><span class="badge bg-secondary bg-opacity-10 text-secondary">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</span>`;

        list.prepend(newItem);
        document.getElementById('purchaseForm').reset();
        alert("–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!");
    }
</script>

<style>
    .fade-in { animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
</style>
{% endblock %}