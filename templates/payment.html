{% extends "base.html" %}
{% block title %}Пополнение баланса{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Карточка пополнения -->
            <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                <!-- Заголовок -->
                <div class="card-header bg-white border-bottom py-4 px-5">
                    <div class="d-flex align-items-center gap-3">
                        <div class="bg-primary bg-opacity-10 text-primary p-3 rounded-circle">
                            <i class="bi bi-wallet2 fs-4"></i>
                        </div>
                        <div>
                            <h2 class="fw-bold mb-1">Пополнение баланса</h2>
                            <p class="text-muted mb-0">Выберите удобный способ оплаты</p>
                        </div>
                    </div>
                </div>

                <!-- Тело карточки -->
                <div class="card-body p-5">
                    <form action="{{url_for('payment')}}" method="post" enctype="multipart/form-data">
                        <!-- Текущий баланс -->
                        <div class="bg-light rounded-3 p-4 mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <small class="text-muted d-block mb-1">Текущий баланс</small>
                                    <h3 class="fw-bold mb-0 text-success">{{ money }} ₽</h3>
                                </div>
                            </div>
                        </div>

                        <!-- Выбор суммы -->
                        <div class="mb-5">
                            <h5 class="fw-bold mb-4">Выберите сумму пополнения</h5>

                            <!-- Произвольная сумма -->
                            <div class="mb-4">
                                <div class="input-group input-group-lg">
                                    <input required name="money" type="number" id="customAmount"
                                        class="form-control rounded-3" placeholder="0" min="10" max="1000000" step="0">
                                    <span class="input-group-text rounded-3 bg-light">₽</span>
                                </div>
                            </div>
                        </div>

                        <!-- Реквизиты счета -->
                        <div class="mb-5">
                            <h5 class="fw-bold mb-4">Реквизиты для оплаты</h5>

                            <div class="bg-white border rounded-3 p-4">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label small fw-bold text-muted">Банк получателя</label>
                                            <div class="border-bottom pb-2">
                                                <span class="fw-bold">ПАО Сбербанк</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label small fw-bold text-muted">БИК</label>
                                            <div class="border-bottom pb-2">
                                                <span class="fw-bold">044525974</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label small fw-bold text-muted">Счет получателя</label>
                                            <div class="border-bottom pb-2">
                                                <span class="fw-bold">40817810500001234567</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label small fw-bold text-muted">ИНН получателя</label>
                                            <div class="border-bottom pb-2">
                                                <span class="fw-bold">7710140679</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="mb-3">
                                            <label class="form-label small fw-bold text-muted">Получатель</label>
                                            <div class="border-bottom pb-2">
                                                <span class="fw-bold">ООО "ШколПит"</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Форма загрузки подтверждения -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Загрузите скриншот чека или подтверждения
                                оплаты</label>
                            <p class="text-muted small mb-3">Поддерживаемые форматы: JPG, PNG, PDF (макс. 5
                                МБ)
                            </p>

                            <!-- Поле для загрузки файла -->
                            <div class="file-upload-container">
                                <!-- Скрытый файловый инпут -->
                                <input type="file" id="fileInput" name="screenshot" class="hidden-input"
                                    accept=".jpg,.jpeg,.png,.pdf" required>

                                <!-- Состояние 1: Файл не выбран -->
                                <div id="emptyState" class="upload-area">
                                    <div class="file-icon">
                                        <i class="bi bi-cloud-arrow-up"></i>
                                    </div>
                                    <p class="text-muted mb-3">Поддерживаемые форматы: .jpg, .png, .pdf
                                    </p>
                                    <button type="button" class="btn btn-primary" id="addFileBtn">
                                        <i class="bi bi-plus-circle"></i> Добавить файл
                                    </button>
                                </div>

                                <!-- Состояние 2: Файл выбран -->
                                <div id="fileState" class="file-preview" style="display: none;">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            <div class="file-icon me-3">
                                                <i class="bi bi-file-earmark-text"></i>
                                            </div>
                                            <div>
                                                <span class="file-name" id="fileName">Название
                                                    файла</span>
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-outline-danger btn-sm btn-remove"
                                            id="removeFileBtn">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Способы оплаты -->
                        <div class="mb-4">
                            <h5 class="fw-bold mb-4">Способ оплаты</h5>

                            <div class="d-flex flex-column gap-3">
                                <div class="form-check payment-method">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="card" checked>
                                    <label
                                        class="form-check-label w-100 d-flex align-items-center gap-3 p-3 border rounded-3"
                                        for="card">
                                        <div class="bg-primary bg-opacity-10 text-primary p-2 rounded">
                                            <i class="bi bi-credit-card fs-4"></i>
                                        </div>
                                        <div>
                                            <h6 class="fw-bold mb-1">Банковская карта</h6>
                                            <small class="text-muted">Visa, Mastercard, МИР</small>
                                        </div>
                                    </label>
                                </div>

                                <div class="form-check payment-method">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="sbp">
                                    <label
                                        class="form-check-label w-100 d-flex align-items-center gap-3 p-3 border rounded-3"
                                        for="sbp">
                                        <div class="bg-success bg-opacity-10 text-success p-2 rounded">
                                            <i class="bi bi-phone fs-4"></i>
                                        </div>
                                        <div>
                                            <h6 class="fw-bold mb-1">СБП (Система быстрых платежей)</h6>
                                            <small class="text-muted">Оплата по QR-коду</small>
                                        </div>
                                    </label>
                                </div>

                                <div class="form-check payment-method">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="balance">
                                    <label
                                        class="form-check-label w-100 d-flex align-items-center gap-3 p-3 border rounded-3"
                                        for="balance">
                                        <div class="bg-warning bg-opacity-10 text-warning p-2 rounded">
                                            <i class="bi bi-cash fs-4"></i>
                                        </div>
                                        <div>
                                            <h6 class="fw-bold mb-1">Родительский счет</h6>
                                            <small class="text-muted">Списать с привязанного счета</small>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="form-check mb-4">
                            <input class="form-check-input" type="checkbox" id="confirmPayment" required>
                            <label class="form-check-label" for="confirmPayment">
                                Я подтверждаю, что оплатил указанную сумму и загружаю действительное
                                подтверждение оплаты
                            </label>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary-custom btn-pill py-3 fs-5 fw-bold"
                                id="submitButton">
                                <i class="bi bi-send-check me-2"></i>Отправить на проверку
                            </button>
                            <a href="{{ url_for('returnback') }}" class="btn btn-light border btn-pill py-2">
                                Вернуться назад
                            </a>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .amount-btn {
        transition: all 0.2s;
        border: 2px solid #dee2e6;
    }

    .amount-btn:hover {
        border-color: #3b82f6;
        background-color: rgba(59, 130, 246, 0.05);
    }

    .amount-btn.active {
        background-color: #3b82f6 !important;
        color: white !important;
        border-color: #3b82f6 !important;
    }

    .payment-method input:checked+label {
        border-color: #3b82f6 !important;
        background-color: rgba(59, 130, 246, 0.05);
    }

    .payment-method label {
        cursor: pointer;
        transition: all 0.2s;
    }

    .payment-method label:hover {
        border-color: #3b82f6;
    }

    #payButton:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .file-upload-container {
        max-width: 400px;
        margin: 20px auto;
    }

    .upload-area {
        border: 2px dashed #0d6efd;
        border-radius: 10px;
        padding: 30px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background-color: #f8f9fa;
    }

    .upload-area:hover {
        background-color: #e7f1ff;
        border-color: #0a58ca;
    }

    .file-icon {
        font-size: 48px;
        color: #0d6efd;
        margin-bottom: 10px;
    }

    .file-preview {
        border: 2px solid #0d6efd;
        border-radius: 10px;
        padding: 20px;
        background-color: #f8f9fa;
    }

    .file-name {
        font-size: 16px;
        font-weight: 500;
        color: #333;
        word-break: break-all;
    }

    .hidden-input {
        display: none;
    }

    .btn-remove {
        color: #dc3545;
        border: 1px solid #dc3545;
    }

    .btn-remove:hover {
        background-color: #dc3545;
        color: white;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        let selectedAmount = 0;
        const payButton = document.getElementById('payButton');
        const displayAmount = document.getElementById('displayAmount');
        const customAmountInput = document.getElementById('customAmount');

        // Обработчики для кнопок быстрого выбора суммы
        document.querySelectorAll('.amount-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                // Снимаем активный класс со всех кнопок
                document.querySelectorAll('.amount-btn').forEach(b => {
                    b.classList.remove('active');
                    b.classList.remove('btn-primary');
                    b.classList.add('btn-outline-primary');
                });

                // Добавляем активный класс на текущую кнопку
                this.classList.add('active');
                this.classList.add('btn-primary');
                this.classList.remove('btn-outline-primary');

                // Устанавливаем выбранную сумму
                selectedAmount = parseInt(this.getAttribute('data-amount'));
                displayAmount.textContent = selectedAmount.toLocaleString('ru-RU');
                customAmountInput.value = selectedAmount;

                // Активируем кнопку оплаты
                payButton.disabled = false;
            });
        });

        // Обработчик для произвольной суммы
        customAmountInput.addEventListener('input', function () {
            const value = parseInt(this.value) || 0;

            // Снимаем выделение с кнопок быстрого выбора
            document.querySelectorAll('.amount-btn').forEach(b => {
                b.classList.remove('active');
                b.classList.remove('btn-primary');
                b.classList.add('btn-outline-primary');
            });

            selectedAmount = value;
            displayAmount.textContent = value.toLocaleString('ru-RU');

            // Проверяем минимальную сумму
            if (value >= 100) {
                payButton.disabled = false;
            } else {
                payButton.disabled = true;
            }
        });

        // Обработчик нажатия кнопки оплаты
        payButton.addEventListener('click', function () {
            if (selectedAmount < 100) {
                alert('Минимальная сумма пополнения - 100 ₽');
                return;
            }

            // Имитация процесса оплаты
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').id;
            let message = `Пополнение на ${selectedAmount} ₽\nСпособ оплаты: `;

            switch (paymentMethod) {
                case 'card':
                    message += 'Банковская карта';
                    break;
                case 'sbp':
                    message += 'СБП';
                    break;
                case 'balance':
                    message += 'Родительский счет';
                    break;
            }

            if (confirm(message + '\n\nПодтвердить оплату?')) {
                // Имитация успешной оплаты
                payButton.innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>Обработка...';
                payButton.disabled = true;

                setTimeout(() => {
                    alert(`✅ Баланс успешно пополнен на ${selectedAmount} ₽!\nНовый баланс: ${parseInt({{ money }}) + selectedAmount} ₽`);

                    // Возвращаем кнопку в исходное состояние
                    payButton.innerHTML = '<i class="bi bi-lock me-2"></i>Пополнить на <span id="displayAmount">0</span> ₽';

                    // Перенаправляем на главную страницу
                    window.location.href = "{{ url_for('dashboard') }}";
                }, 1500);
            }
        });

        // Изначально деактивируем кнопку оплаты
        payButton.disabled = true;
    });

    document.addEventListener('DOMContentLoaded', function () {
        const fileInput = document.getElementById('paymentProof');
        const fileUploadArea = document.getElementById('fileUploadArea');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');
        const filePreview = document.getElementById('filePreview');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const submitButton = document.getElementById('submitButton');
        const confirmCheckbox = document.getElementById('confirmPayment');

        // Обработка drag & drop
        fileUploadArea.addEventListener('dragover', function (e) {
            e.preventDefault();
            this.classList.add('dragover');
        });

        fileUploadArea.addEventListener('dragleave', function () {
            this.classList.remove('dragover');
        });

        fileUploadArea.addEventListener('drop', function (e) {
            e.preventDefault();
            this.classList.remove('dragover');

            if (e.dataTransfer.files.length > 0) {
                handleFileSelect(e.dataTransfer.files[0]);
                fileInput.files = e.dataTransfer.files;
            }
        });

        fileUploadArea.addEventListener('click', function () {
            fileInput.click();
        });

        fileInput.addEventListener('change', function () {
            if (this.files.length > 0) {
                handleFileSelect(this.files[0]);
            }
        });

        function handleFileSelect(file) {
            // Проверка размера файла (макс. 5 МБ)
            const maxSize = 5 * 1024 * 1024; // 5 MB
            if (file.size > maxSize) {
                alert('Файл слишком большой. Максимальный размер: 5 МБ');
                return;
            }

            // Проверка типа файла
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
            if (!validTypes.includes(file.type)) {
                alert('Недопустимый формат файла. Разрешены: JPG, PNG, PDF');
                return;
            }

            // Показываем превью
            uploadPlaceholder.classList.add('d-none');
            filePreview.classList.remove('d-none');

            // Обновляем информацию о файле
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);

            // Активируем кнопку отправки, если чекбокс отмечен
            updateSubmitButton();
        }

        function removeFile() {
            fileInput.value = '';
            uploadPlaceholder.classList.remove('d-none');
            filePreview.classList.add('d-none');
            updateSubmitButton();
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / 1048576).toFixed(1) + ' MB';
        }

        function updateSubmitButton() {
            const hasFile = fileInput.files.length > 0;
            const isConfirmed = confirmCheckbox.checked;
            const hasPaymentMethod = document.getElementById('paymentMethod').value !== '';

            submitButton.disabled = !(hasFile && isConfirmed && hasPaymentMethod);
        }

        // Слушаем изменения в форме
        confirmCheckbox.addEventListener('change', updateSubmitButton);
        document.getElementById('paymentMethod').addEventListener('change', updateSubmitButton);

        // Изначально деактивируем кнопку отправки
        submitButton.disabled = true;
    });

    document.addEventListener('DOMContentLoaded', function () {
        const fileInput = document.getElementById('paymentProof');
        const fileUploadArea = document.getElementById('fileUploadArea');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');
        const filePreview = document.getElementById('filePreview');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const submitButton = document.getElementById('submitButton');
        const confirmCheckbox = document.getElementById('confirmPayment');

        // Удаляем обработчики drag & drop, чтобы не предлагать ввод файла
        fileUploadArea.removeEventListener('dragover', handleDragOver);
        fileUploadArea.removeEventListener('dragleave', handleDragLeave);
        fileUploadArea.removeEventListener('drop', handleDrop);
        fileUploadArea.removeEventListener('click', handleAreaClick);

        // Обработчик для кнопки "Выбрать файл"
        document.querySelector('button[onclick*="paymentProof"]').addEventListener('click', function (e) {
            e.stopPropagation(); // Останавливаем всплытие события
            fileInput.click();
        });

        fileInput.addEventListener('change', function () {
            if (this.files.length > 0) {
                handleFileSelect(this.files[0]);
            }
        });

        function handleFileSelect(file) {
            // Проверка размера файла (макс. 5 МБ)
            const maxSize = 5 * 1024 * 1024; // 5 MB
            if (file.size > maxSize) {
                alert('Файл слишком большой. Максимальный размер: 5 МБ');
                return;
            }

            // Проверка типа файла
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
            if (!validTypes.includes(file.type)) {
                alert('Недопустимый формат файла. Разрешены: JPG, PNG, PDF');
                return;
            }

            // Показываем превью
            uploadPlaceholder.classList.add('d-none');
            filePreview.classList.remove('d-none');

            // Обновляем информацию о файле
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);

            // Активируем кнопку отправки, если чекбокс отмечен
            updateSubmitButton();
        }

        function removeFile() {
            // Сбрасываем значение input
            fileInput.value = '';

            // Скрываем превью файла
            filePreview.classList.add('d-none');

            // НЕ показываем плейсхолдер с предложением загрузить файл
            uploadPlaceholder.classList.add('d-none');

            // Обновляем состояние кнопки отправки
            updateSubmitButton();
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / 1048576).toFixed(1) + ' MB';
        }

        function updateSubmitButton() {
            const hasFile = fileInput.files.length > 0;
            const isConfirmed = confirmCheckbox.checked;

            submitButton.disabled = !(hasFile && isConfirmed);
        }

        // Слушаем изменения в форме
        confirmCheckbox.addEventListener('change', updateSubmitButton);

        // Изначально деактивируем кнопку отправки
        submitButton.disabled = true;
    });

    // Делаем функцию removeFile глобальной для вызова из HTML
    window.removeFile = function () {
        // Находим элементы каждый раз при вызове на случай, если они были пересозданы
        const fileInput = document.getElementById('paymentProof');
        const filePreview = document.getElementById('filePreview');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');

        if (fileInput) fileInput.value = '';
        if (filePreview) filePreview.classList.add('d-none');
        if (uploadPlaceholder) uploadPlaceholder.classList.add('d-none');

        // Обновляем состояние кнопки отправки
        const submitButton = document.getElementById('submitButton');
        const confirmCheckbox = document.getElementById('confirmPayment');

        if (submitButton && confirmCheckbox) {
            submitButton.disabled = !confirmCheckbox.checked;
        }
    };

    document.addEventListener('DOMContentLoaded', function () {
        const fileInput = document.getElementById('fileInput');
        const emptyState = document.getElementById('emptyState');
        const fileState = document.getElementById('fileState');
        const addFileBtn = document.getElementById('addFileBtn');
        const removeFileBtn = document.getElementById('removeFileBtn');
        const fileName = document.getElementById('fileName');

        // Клик по всей области загрузки или кнопке
        emptyState.addEventListener('click', function (e) {
            if (e.target !== addFileBtn && !addFileBtn.contains(e.target)) {
                fileInput.click();
            }
        });

        addFileBtn.addEventListener('click', function () {
            fileInput.click();
        });

        // Обработка выбора файла
        fileInput.addEventListener('change', function () {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                const fileExt = file.name.split('.').pop().toLowerCase();

                // Проверка расширения файла
                const allowedExtensions = ['jpg', 'jpeg', 'png', 'pdf'];

                if (!allowedExtensions.includes(fileExt)) {
                    alert('Пожалуйста, выберите файл с расширением .jpg, .png или .pdf');
                    this.value = ''; // Сброс выбора
                    return;
                }

                // Обновление отображения
                fileName.textContent = file.name;

                // Смена иконки в зависимости от типа файла
                const fileIcon = fileState.querySelector('.file-icon i');
                if (fileExt === 'pdf') {
                    fileIcon.className = 'bi bi-file-earmark-pdf';
                    fileIcon.style.color = '#dc3545';
                } else if (['jpg', 'jpeg', 'png'].includes(fileExt)) {
                    fileIcon.className = 'bi bi-file-earmark-image';
                    fileIcon.style.color = '#198754';
                }

                // Переключение состояний
                emptyState.style.display = 'none';
                fileState.style.display = 'block';
            }
        });

        // Удаление файла
        removeFileBtn.addEventListener('click', function () {
            fileInput.value = ''; // Очистка выбора файла
            emptyState.style.display = 'block';
            fileState.style.display = 'none';
        });

        // Для совместимости с отправкой формы
        document.getElementById('myForm').addEventListener('submit', function (e) {
            // Проверка, выбран ли файл
            if (!fileInput.files[0]) {
                e.preventDefault();
                alert('Пожалуйста, выберите файл перед отправкой формы');
                return;
            }

            // Здесь можно добавить дополнительную валидацию
            console.log('Форма отправляется с файлом:', fileInput.files[0].name);
        });
    });

</script>
{% endblock %}